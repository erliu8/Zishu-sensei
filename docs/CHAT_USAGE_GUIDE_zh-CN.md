# 紫书AI助手聊天功能使用指南

## 快速开始

### 前置要求
1. 准备一个可用的大模型 API：
   - OpenAI API (GPT-3.5/GPT-4)
   - 通义千问 API
   - DeepSeek API
   - Claude API
   - 或其他兼容 OpenAI 格式的 API

2. 获取 API Key
   - 前往对应服务商官网注册并获取 API 密钥
   - 确保账户有足够的余额

### 步骤 1：创建角色模板

1. 打开桌面应用
2. 点击"角色模板"或"Character Template"
3. 点击"创建新模板"
4. 填写基本信息：
   - 角色名称：如"智能助手"
   - 描述：角色的简介
   - Live2D 模型：选择你喜欢的形象

5. 配置 Prompt（系统提示词）：
   ```
   你是一个友善、专业的AI助手。你的任务是回答用户的问题，
   提供有用的信息和建议。请保持礼貌、准确，并且容易理解。
   ```

6. 配置 LLM（大语言模型）：
   - **模型类型**：选择 "API"
   - **提供商**：
     - `openai` - GPT 系列
     - `qwen` - 通义千问
     - `deepseek` - DeepSeek
     - `anthropic` - Claude
     - `custom` - 自定义（兼容 OpenAI 格式的API）
   
   - **API Key**：粘贴你的 API 密钥
   - **模型名称**：
     - OpenAI: `gpt-3.5-turbo`, `gpt-4`, `gpt-4-turbo`
     - 通义千问: `qwen-turbo`, `qwen-plus`, `qwen-max`
     - DeepSeek: `deepseek-chat`
   
   - **API 端点**（可选）：
     - OpenAI: `https://api.openai.com/v1`
     - 通义千问: `https://dashscope.aliyuncs.com/compatible-mode/v1`
     - DeepSeek: `https://api.deepseek.com/v1`

7. 点击"保存"

### 步骤 2：开始聊天

1. 点击桌面应用的"聊天"按钮
2. 在聊天窗口底部的角色选择器中，选择刚创建的角色模板
3. 在输入框中输入消息
4. 点击"发送"或按回车键
5. 等待AI助手回复

## 示例配置

### 配置 1：通义千问（推荐国内用户）

```json
{
  "提供商": "custom",
  "API Key": "sk-xxxxxxxxxxxxxxxxxxxx",
  "模型名称": "qwen-turbo",
  "API 端点": "https://dashscope.aliyuncs.com/compatible-mode/v1"
}
```

### 配置 2：OpenAI GPT

```json
{
  "提供商": "openai",
  "API Key": "sk-xxxxxxxxxxxxxxxxxxxx",
  "模型名称": "gpt-3.5-turbo",
  "API 端点": "https://api.openai.com/v1"
}
```

### 配置 3：DeepSeek

```json
{
  "提供商": "deepseek",
  "API Key": "sk-xxxxxxxxxxxxxxxxxxxx",
  "模型名称": "deepseek-chat",
  "API 端点": "https://api.deepseek.com/v1"
}
```

## 常见问题

### Q1: 显示"当前未配置推理引擎"
**原因**：
- 未选择角色模板
- 角色模板未正确配置 API
- Docker 容器重启导致适配器注册信息丢失

**解决方法**：
1. 确保在聊天窗口底部选择了已配置的角色模板
2. 检查角色模板的 LLM 配置是否正确
3. 尝试重新发送消息（系统会自动重新注册适配器）

### Q2: API 调用失败 (401)
**原因**：API Key 无效或已过期

**解决方法**：
1. 检查 API Key 是否正确（无多余空格）
2. 确认 API Key 是否有效且未过期
3. 检查账户余额是否充足

### Q3: API 调用超时
**原因**：网络问题或 API 服务延迟

**解决方法**：
1. 检查网络连接
2. 如果在国内，尝试使用国内服务商（如通义千问）
3. 稍后重试

### Q4: 每次容器重启都需要重新配置吗？
**回答**：不需要。角色模板配置保存在前端，容器重启后：
- 角色模板配置保留
- 系统会自动重新注册适配器
- 首次发送消息时可能稍慢（等待适配器注册）

## 高级功能

### 自定义系统提示词

通过修改 Prompt，你可以让AI助手扮演不同角色：

**示例 1：编程助手**
```
你是一位经验丰富的软件工程师。你擅长Python、JavaScript、Go等编程语言。
请帮助用户解决编程问题，提供清晰的代码示例，并解释实现原理。
```

**示例 2：创意写作助手**
```
你是一位富有创意的写作助手。你擅长故事创作、诗歌写作和文案策划。
请用生动的语言帮助用户完成创作任务。
```

**示例 3：学习导师**
```
你是一位耐心的学习导师。请用通俗易懂的语言解释复杂概念，
多使用类比和例子，帮助用户理解和掌握知识。
```

### 调整生成参数

在 API 请求中可以调整以下参数（目前需要通过代码修改）：

- `temperature` (0.0-2.0)：控制回复的随机性
  - 0.0：最确定、最保守的回复
  - 0.7：平衡（默认）
  - 1.5：更有创意、更随机

- `max_tokens`：控制回复的最大长度
  - 默认：2000
  - 建议范围：100-4000

## 安全提示

1. **保护 API Key**
   - 不要分享你的 API Key
   - 定期轮换 API Key
   - 设置使用额度限制

2. **注意成本**
   - 了解API的计费方式
   - 监控使用量
   - 设置预算提醒

3. **数据隐私**
   - 不要发送敏感信息
   - 了解服务商的数据政策

## 技术支持

遇到问题时，请提供以下信息：

1. 错误消息（截图或文本）
2. 使用的模型和提供商
3. Docker 日志：
   ```bash
   docker logs zishu-api --tail 100
   ```

4. 适配器列表：
   ```bash
   curl -s http://localhost:8000/api/adapters/list
   ```

## 更新日志

**2025-11-18**
- ✅ 修复适配器返回结果格式问题
- ✅ 实现自动启动未运行的适配器
- ✅ 改进错误处理和日志记录
- ✅ 容器重启后自动重新注册适配器

**待实现**
- [ ] 适配器配置持久化到数据库
- [ ] 对话历史持久化
- [ ] 多角色同时对话
- [ ] 语音输入输出
- [ ] 流式输出支持
