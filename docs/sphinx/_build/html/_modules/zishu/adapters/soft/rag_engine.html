<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>zishu.adapters.soft.rag_engine &mdash; Zishu-Sensei Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css?v=a5c4661c" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=fcc5c311" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=34088549"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../_static/copybutton.js?v=30646c52"></script>
        <script src="../../../../_static/tabs.js?v=3030b3cb"></script>
        <script src="../../../../_static/translations.js?v=beaddf03"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Zishu-Sensei
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">用户指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/introduction.html">项目简介</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#zishu-sensei">什么是 Zishu-Sensei？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id2">核心功能</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id3">智能对话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id4">知识检索</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id5">学习辅助</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id6">知识管理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id7">系统架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id8">技术特点</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id9">高性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id10">可扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id11">安全可靠</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id12">易于部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id13">应用场景</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id14">教育机构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id15">个人学习</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id16">企业培训</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/introduction.html#id17">研究辅助</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id18">开发团队</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/introduction.html#id19">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/installation.html">安装指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id2">系统要求</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id3">硬件要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id4">软件要求</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id5">安装方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#docker">方式一: Docker 部署 (推荐)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id6">步骤 1: 安装 Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id7">步骤 2: 克隆项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id8">步骤 3: 配置环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id9">步骤 4: 启动服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id10">步骤 5: 验证安装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id11">方式二: 本地开发安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#python">步骤 1: 安装 Python 依赖</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id12">步骤 2: 安装数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id13">步骤 3: 配置数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id14">步骤 4: 运行数据库迁移</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id15">步骤 5: 启动应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id16">步骤 6: 验证安装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id17">方式三: 云平台部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id18">云硬盘环境 (推荐用于生产)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id19">云服务器部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id20">常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id21">端口冲突</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id22">权限问题</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id23">数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/installation.html#id24">模型下载慢</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id25">卸载</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/installation.html#id26">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/quickstart.html">快速开始</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id2">安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#docker">使用 Docker (推荐)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id3">本地安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id4">验证安装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id5">基本使用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id6">1. 创建用户</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id7">2. 登录获取令牌</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id8">3. 开始对话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id9">4. 发送消息</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id10">使用桌面应用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id11">启动应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id12">配置连接</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id13">开始对话</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id14">上传文档</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id15">准备文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id16">上传文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id17">查看处理状态</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#rag">使用 RAG 查询</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id18">启用 RAG</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id19">查看引用来源</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id20">配置选项</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id21">基本配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#llm">LLM 提供商</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id22">常见任务</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id23">管理对话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id24">管理文档</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id25">搜索文档</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id26">故障排除</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#api">API 无法访问</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id27">数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/quickstart.html#id28">上传文档失败</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id29">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/quickstart.html#id30">需要帮助？</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/configuration.html">配置指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id2">配置文件结构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id3">主要配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id4">环境变量</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id5">主配置文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#llm">LLM 模型配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#openai">OpenAI 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#claude-anthropic">Claude (Anthropic) 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id6">本地模型配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#rag">RAG 配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id7">基础配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id8">重排序配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id9">文档解析配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id10">适配器配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#core-adapter">Core Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#soft-adapter">Soft Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#hard-adapter">Hard Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id11">日志配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id12">基础日志配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id13">性能优化配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id14">数据库连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id15">缓存策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id16">并发控制</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id17">安全配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id18">认证和授权</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id19">数据加密</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id20">监控配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#prometheus">Prometheus 指标</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id21">健康检查</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id22">环境特定配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id23">开发环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/configuration.html#id24">生产环境</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id25">配置加载优先级</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id26">配置验证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id27">最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/configuration.html#id28">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/deployment.html">部署指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id2">部署架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#docker">Docker 部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#docker-compose">生产环境 Docker Compose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id3">启动生产环境</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#kubernetes">Kubernetes 部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id4">准备工作</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id5">创建命名空间</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id6">部署配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id7">服务配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#ingress">Ingress 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#k8s">部署到 K8s</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id8">云平台部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#aws">AWS 部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#azure">Azure 部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#gcp">GCP 部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#nginx">Nginx 配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id9">生产环境 Nginx 配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#ssl">SSL 证书配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#let-s-encrypt">使用 Let’s Encrypt</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id10">数据库优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#postgresql">PostgreSQL 优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id11">主从复制</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id12">监控和日志</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#prometheus-grafana">Prometheus + Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id13">日志聚合</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id14">备份策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id15">数据库备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id16">自动备份</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id17">故障恢复</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id18">数据恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id19">灾难恢复计划</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id20">性能调优</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id21">应用层优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id22">负载均衡</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id23">扩展策略</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id24">安全加固</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id25">防火墙规则</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user_guide/deployment.html#id26">定期更新</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id27">检查清单</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user_guide/deployment.html#id28">下一步</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/architecture.html">系统架构</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id2">整体架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id3">核心设计原则</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#srp">1. 单一职责原则 (SRP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#ocp">2. 开闭原则 (OCP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#dip">3. 依赖倒置原则 (DIP)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id4">适配器架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id5">适配器模式详解</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#core-adapter">Core Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#soft-adapter">Soft Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#hard-adapter">Hard Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id6">数据流架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id7">请求处理流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id8">对话处理流程</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id9">数据模型设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id10">核心实体关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id11">用户模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id12">对话模型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id13">缓存策略</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id14">多层缓存架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id15">缓存实现</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id16">异步处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id17">任务队列</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id18">错误处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id19">统一异常处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id20">安全架构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id21">认证和授权</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id22">扩展性设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id23">水平扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id24">垂直扩展</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id25">性能优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#id26">数据库优化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/architecture.html#api">API 优化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/architecture.html#id27">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/development_setup.html">开发环境配置</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id2">前置要求</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id3">开发工具</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id4">环境配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id5">1. 克隆仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id6">2. 创建虚拟环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id7">3. 安装依赖</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id8">4. 配置环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id9">5. 初始化数据库</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id10">开发工作流</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id11">启动开发服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id12">代码编辑</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id13">代码质量检查</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id14">开发工具</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#vs-code">VS Code 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id15">调试配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id16">数据库管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#pgadmin">使用 pgAdmin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id17">数据库迁移</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#redis">Redis 管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#redis-commander">使用 Redis Commander</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#redis-cli">使用 Redis CLI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id18">前端开发</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#desktop-app">Desktop App 开发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id19">测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id20">运行测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id21">编写测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id22">性能分析</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#profiling">Profiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id23">监控</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id24">调试技巧</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id25">日志调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id26">断点调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id27">远程调试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id28">常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id29">依赖冲突</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id30">数据库连接失败</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id31">端口占用</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id32">最佳实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/development_setup.html#id33">下一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer_guide/coding_standards.html">编码规范</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#python">Python 代码规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id2">风格指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id3">命名约定</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id4">导入顺序</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id5">类型注解</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id6">文档字符串</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id7">错误处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id8">异步编程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id9">代码组织</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id10">性能优化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id11">数据库查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id12">缓存策略</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id13">批处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id14">测试规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id15">单元测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id16">集成测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id17">测试覆盖率</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id18">安全规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id19">输入验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id20">密码处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#sql">SQL 注入防护</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id21">敏感数据</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id22">代码审查</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id23">审查清单</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#git">Git 提交规范</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id24">提交消息格式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id25">分支策略</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id26">工具配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#black">Black (代码格式化)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#pylint">Pylint (代码检查)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#mypy">MyPy (类型检查)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developer_guide/coding_standards.html#id27">参考资源</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API 参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/core.html">核心模块 API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/core.html#id1">核心配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/core.html#id2">核心异常</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/core.html#id3">核心基类</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/adapters.html">适配器 API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/adapters.html#id1">适配器概述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#module-zishu.adapters.base">适配器基类</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#id3">适配器系统 - 基础模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.BaseAdapter"><code class="docutils literal notranslate"><span class="pre">BaseAdapter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.ExecutionContext"><code class="docutils literal notranslate"><span class="pre">ExecutionContext</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.ExecutionResult"><code class="docutils literal notranslate"><span class="pre">ExecutionResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.HealthCheckResult"><code class="docutils literal notranslate"><span class="pre">HealthCheckResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterMetadata"><code class="docutils literal notranslate"><span class="pre">AdapterMetadata</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterCapability"><code class="docutils literal notranslate"><span class="pre">AdapterCapability</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterDependency"><code class="docutils literal notranslate"><span class="pre">AdapterDependency</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterPermissions"><code class="docutils literal notranslate"><span class="pre">AdapterPermissions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.BaseAdapterException"><code class="docutils literal notranslate"><span class="pre">BaseAdapterException</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterRegistrationError"><code class="docutils literal notranslate"><span class="pre">AdapterRegistrationError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterNotFoundError"><code class="docutils literal notranslate"><span class="pre">AdapterNotFoundError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterAlreadyExistsError"><code class="docutils literal notranslate"><span class="pre">AdapterAlreadyExistsError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterLoadingError"><code class="docutils literal notranslate"><span class="pre">AdapterLoadingError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterExecutionError"><code class="docutils literal notranslate"><span class="pre">AdapterExecutionError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterValidationError"><code class="docutils literal notranslate"><span class="pre">AdapterValidationError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterConfigurationError"><code class="docutils literal notranslate"><span class="pre">AdapterConfigurationError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterTimeoutError"><code class="docutils literal notranslate"><span class="pre">AdapterTimeoutError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.DependencyMissingError"><code class="docutils literal notranslate"><span class="pre">DependencyMissingError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.SoftAdapterError"><code class="docutils literal notranslate"><span class="pre">SoftAdapterError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.RAGEngineError"><code class="docutils literal notranslate"><span class="pre">RAGEngineError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.PromptTemplateError"><code class="docutils literal notranslate"><span class="pre">PromptTemplateError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.KnowledgeBaseError"><code class="docutils literal notranslate"><span class="pre">KnowledgeBaseError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.RetrievalFailedError"><code class="docutils literal notranslate"><span class="pre">RetrievalFailedError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterType"><code class="docutils literal notranslate"><span class="pre">AdapterType</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterStatus"><code class="docutils literal notranslate"><span class="pre">AdapterStatus</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.SecurityLevel"><code class="docutils literal notranslate"><span class="pre">SecurityLevel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.ErrorCode"><code class="docutils literal notranslate"><span class="pre">ErrorCode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.ExceptionSeverity"><code class="docutils literal notranslate"><span class="pre">ExceptionSeverity</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.AdapterRegistry"><code class="docutils literal notranslate"><span class="pre">AdapterRegistry</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.HealthMonitor"><code class="docutils literal notranslate"><span class="pre">HealthMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.SecurityManager"><code class="docutils literal notranslate"><span class="pre">SecurityManager</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.PerformanceMonitor"><code class="docutils literal notranslate"><span class="pre">PerformanceMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.create_adapter_registry"><code class="docutils literal notranslate"><span class="pre">create_adapter_registry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.get_default_registry"><code class="docutils literal notranslate"><span class="pre">get_default_registry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.set_default_registry"><code class="docutils literal notranslate"><span class="pre">set_default_registry()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.base.handle_adapter_exceptions"><code class="docutils literal notranslate"><span class="pre">handle_adapter_exceptions()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/adapters.html#core-adapter">Core Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#id12">核心适配器主类</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#module-zishu.adapters.core.services.health_service">健康检查服务</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.HealthMetricType"><code class="docutils literal notranslate"><span class="pre">HealthMetricType</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.HealthMetric"><code class="docutils literal notranslate"><span class="pre">HealthMetric</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.HealthThreshold"><code class="docutils literal notranslate"><span class="pre">HealthThreshold</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.HealthMetricsInfo"><code class="docutils literal notranslate"><span class="pre">HealthMetricsInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.AdapterHealthStatus"><code class="docutils literal notranslate"><span class="pre">AdapterHealthStatus</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.HealthMonitor"><code class="docutils literal notranslate"><span class="pre">HealthMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.AdapterHealthService"><code class="docutils literal notranslate"><span class="pre">AdapterHealthService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.AvailabilityMonitor"><code class="docutils literal notranslate"><span class="pre">AvailabilityMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.ResponseTimeMonitor"><code class="docutils literal notranslate"><span class="pre">ResponseTimeMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.ErrorRateMonitor"><code class="docutils literal notranslate"><span class="pre">ErrorRateMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.MemoryUsageMonitor"><code class="docutils literal notranslate"><span class="pre">MemoryUsageMonitor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.health_service.ThroughputMonitor"><code class="docutils literal notranslate"><span class="pre">ThroughputMonitor</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#module-zishu.adapters.core.services.event_service">事件服务</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.EventDeliveryMode"><code class="docutils literal notranslate"><span class="pre">EventDeliveryMode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.EventPersistenceMode"><code class="docutils literal notranslate"><span class="pre">EventPersistenceMode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.EventSubscription"><code class="docutils literal notranslate"><span class="pre">EventSubscription</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.EventDeliveryResult"><code class="docutils literal notranslate"><span class="pre">EventDeliveryResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.EventMetrics"><code class="docutils literal notranslate"><span class="pre">EventMetrics</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.AdapterEventService"><code class="docutils literal notranslate"><span class="pre">AdapterEventService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.LoggingEventHandler"><code class="docutils literal notranslate"><span class="pre">LoggingEventHandler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.MetricsEventHandler"><code class="docutils literal notranslate"><span class="pre">MetricsEventHandler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.core.services.event_service.FilterEventHandler"><code class="docutils literal notranslate"><span class="pre">FilterEventHandler</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/adapters.html#soft-adapter">Soft Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#id15">软适配器主类</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#module-zishu.adapters.soft.rag_engine">RAG 引擎</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine"><code class="docutils literal notranslate"><span class="pre">RAGEngine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGConfig"><code class="docutils literal notranslate"><span class="pre">RAGConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalConfig"><code class="docutils literal notranslate"><span class="pre">RetrievalConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.GenerationConfig"><code class="docutils literal notranslate"><span class="pre">GenerationConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingConfig"><code class="docutils literal notranslate"><span class="pre">RerankingConfig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGResult"><code class="docutils literal notranslate"><span class="pre">RAGResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalResult"><code class="docutils literal notranslate"><span class="pre">RetrievalResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.QueryResult"><code class="docutils literal notranslate"><span class="pre">QueryResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngineError"><code class="docutils literal notranslate"><span class="pre">RAGEngineError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore"><code class="docutils literal notranslate"><span class="pre">DocumentStore</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore"><code class="docutils literal notranslate"><span class="pre">VectorStore</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.EmbeddingService"><code class="docutils literal notranslate"><span class="pre">EmbeddingService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalService"><code class="docutils literal notranslate"><span class="pre">RetrievalService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingService"><code class="docutils literal notranslate"><span class="pre">RerankingService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore"><code class="docutils literal notranslate"><span class="pre">MemoryDocumentStore</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore"><code class="docutils literal notranslate"><span class="pre">MemoryVectorStore</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MockEmbeddingService"><code class="docutils literal notranslate"><span class="pre">MockEmbeddingService</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGMode"><code class="docutils literal notranslate"><span class="pre">RAGMode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalStrategy"><code class="docutils literal notranslate"><span class="pre">RetrievalStrategy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RankingMethod"><code class="docutils literal notranslate"><span class="pre">RankingMethod</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.GenerationMode"><code class="docutils literal notranslate"><span class="pre">GenerationMode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Retriever"><code class="docutils literal notranslate"><span class="pre">Retriever</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.SimilarityRetriever"><code class="docutils literal notranslate"><span class="pre">SimilarityRetriever</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridRetriever"><code class="docutils literal notranslate"><span class="pre">HybridRetriever</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.KeywordRetriever"><code class="docutils literal notranslate"><span class="pre">KeywordRetriever</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Reranker"><code class="docutils literal notranslate"><span class="pre">Reranker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.CosineSimilarityReranker"><code class="docutils literal notranslate"><span class="pre">CosineSimilarityReranker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.BM25Reranker"><code class="docutils literal notranslate"><span class="pre">BM25Reranker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridReranker"><code class="docutils literal notranslate"><span class="pre">HybridReranker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ReciprocalRankFusionReranker"><code class="docutils literal notranslate"><span class="pre">ReciprocalRankFusionReranker</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Generator"><code class="docutils literal notranslate"><span class="pre">Generator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.PromptBasedGenerator"><code class="docutils literal notranslate"><span class="pre">PromptBasedGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ChainOfThoughtGenerator"><code class="docutils literal notranslate"><span class="pre">ChainOfThoughtGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridGenerator"><code class="docutils literal notranslate"><span class="pre">HybridGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.FactCheckingGenerator"><code class="docutils literal notranslate"><span class="pre">FactCheckingGenerator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngineFactory"><code class="docutils literal notranslate"><span class="pre">RAGEngineFactory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGPerformanceOptimizer"><code class="docutils literal notranslate"><span class="pre">RAGPerformanceOptimizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils"><code class="docutils literal notranslate"><span class="pre">RAGUtils</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#id16">主要类和方法</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#module-zishu.adapters.soft.prompt_engine">Prompt 引擎</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.DynamicPromptEngine"><code class="docutils literal notranslate"><span class="pre">DynamicPromptEngine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptEngine"><code class="docutils literal notranslate"><span class="pre">PromptEngine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptTemplate"><code class="docutils literal notranslate"><span class="pre">PromptTemplate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptVariable"><code class="docutils literal notranslate"><span class="pre">PromptVariable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptContext"><code class="docutils literal notranslate"><span class="pre">PromptContext</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.TemplateLoader"><code class="docutils literal notranslate"><span class="pre">TemplateLoader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptValidator"><code class="docutils literal notranslate"><span class="pre">PromptValidator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptCache"><code class="docutils literal notranslate"><span class="pre">PromptCache</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptOptimizer"><code class="docutils literal notranslate"><span class="pre">PromptOptimizer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptEngineError"><code class="docutils literal notranslate"><span class="pre">PromptEngineError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptTemplateError"><code class="docutils literal notranslate"><span class="pre">PromptTemplateError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.PromptValidationError"><code class="docutils literal notranslate"><span class="pre">PromptValidationError</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.create_prompt_engine"><code class="docutils literal notranslate"><span class="pre">create_prompt_engine()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.get_global_engine"><code class="docutils literal notranslate"><span class="pre">get_global_engine()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#zishu.adapters.soft.prompt_engine.render"><code class="docutils literal notranslate"><span class="pre">render()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../api/adapters.html#id40">主要类和方法</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/adapters.html#hard-adapter">Hard Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/adapters.html#id62">硬适配器主类</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/adapters.html#id63">适配器工厂</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/services.html">服务层 API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id1">服务层概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id2">用户服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id3">认证服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id4">对话服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id5">文档服务</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/services.html#id6">知识库服务</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/models.html">数据模型 API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/models.html#id1">数据库模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id2">用户模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id3">对话模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id4">消息模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id5">文档模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id6">知识库模型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/models.html#pydantic">Pydantic 模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id7">请求模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id8">响应模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/models.html#id9">通用模型</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/utils.html">工具函数 API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id1">通用工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id2">文本处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id3">日期时间</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id4">加密工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id5">验证工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/utils.html#id6">日志工具</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Zishu-Sensei</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">模块代码</a></li>
      <li class="breadcrumb-item active">zishu.adapters.soft.rag_engine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>zishu.adapters.soft.rag_engine 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">RAG（检索增强生成）引擎</span>
<span class="sd">集成检索、排序、生成等功能，提供企业级RAG解决方案</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># 第三方库导入</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

    <span class="n">NUMPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">NUMPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TfidfVectorizer</span>

    <span class="n">SKLEARN_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SKLEARN_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>

    <span class="n">SENTENCE_TRANSFORMERS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SENTENCE_TRANSFORMERS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 项目内部导入</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.performance</span><span class="w"> </span><span class="kn">import</span> <span class="n">PerformanceMonitor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.knowledge_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">KnowledgeBaseAdapter</span><span class="p">,</span> <span class="n">Document</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.prompt_engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptEngine</span>


<span class="c1"># ================================</span>
<span class="c1"># 异常类定义</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGEngineError">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngineError">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGEngineError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG引擎异常基类&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<span class="c1"># ================================</span>
<span class="c1"># 核心枚举和数据结构定义</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGMode">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGMode">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG模式枚举&quot;&quot;&quot;</span>

    <span class="n">NAIVE</span> <span class="o">=</span> <span class="s2">&quot;naive&quot;</span>  <span class="c1"># 简单RAG</span>
    <span class="n">ADAPTIVE</span> <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span>  <span class="c1"># 自适应RAG</span>
    <span class="n">ITERATIVE</span> <span class="o">=</span> <span class="s2">&quot;iterative&quot;</span>  <span class="c1"># 迭代RAG</span>
    <span class="n">MULTI_HOP</span> <span class="o">=</span> <span class="s2">&quot;multi_hop&quot;</span>  <span class="c1"># 多跳RAG</span>
    <span class="n">HIERARCHICAL</span> <span class="o">=</span> <span class="s2">&quot;hierarchical&quot;</span>  <span class="c1"># 分层RAG</span>
    <span class="n">HYBRID</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span>  <span class="c1"># 混合RAG</span></div>



<div class="viewcode-block" id="RetrievalStrategy">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalStrategy">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RetrievalStrategy</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;检索策略枚举&quot;&quot;&quot;</span>

    <span class="n">SIMILARITY</span> <span class="o">=</span> <span class="s2">&quot;similarity&quot;</span>  <span class="c1"># 相似度检索</span>
    <span class="n">KEYWORD</span> <span class="o">=</span> <span class="s2">&quot;keyword&quot;</span>  <span class="c1"># 关键词检索</span>
    <span class="n">SEMANTIC</span> <span class="o">=</span> <span class="s2">&quot;semantic&quot;</span>  <span class="c1"># 语义检索</span>
    <span class="n">HYBRID_SEARCH</span> <span class="o">=</span> <span class="s2">&quot;hybrid_search&quot;</span>  <span class="c1"># 混合检索</span>
    <span class="n">GRAPH_SEARCH</span> <span class="o">=</span> <span class="s2">&quot;graph_search&quot;</span>  <span class="c1"># 图检索</span>
    <span class="n">QUERY_EXPANSION</span> <span class="o">=</span> <span class="s2">&quot;query_expansion&quot;</span>  <span class="c1"># 查询扩展</span></div>



<div class="viewcode-block" id="RankingMethod">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RankingMethod">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RankingMethod</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;排序方法枚举&quot;&quot;&quot;</span>

    <span class="n">COSINE_SIMILARITY</span> <span class="o">=</span> <span class="s2">&quot;cosine_similarity&quot;</span>
    <span class="n">BM25</span> <span class="o">=</span> <span class="s2">&quot;bm25&quot;</span>
    <span class="n">CROSS_ENCODER</span> <span class="o">=</span> <span class="s2">&quot;cross_encoder&quot;</span>
    <span class="n">RECIPROCAL_RANK_FUSION</span> <span class="o">=</span> <span class="s2">&quot;rrf&quot;</span>
    <span class="n">HYBRID_RANKING</span> <span class="o">=</span> <span class="s2">&quot;hybrid_ranking&quot;</span>
    <span class="n">LEARNING_TO_RANK</span> <span class="o">=</span> <span class="s2">&quot;ltr&quot;</span></div>



<div class="viewcode-block" id="GenerationMode">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.GenerationMode">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GenerationMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;生成模式枚举&quot;&quot;&quot;</span>

    <span class="n">EXTRACTIVE</span> <span class="o">=</span> <span class="s2">&quot;extractive&quot;</span>  <span class="c1"># 抽取式</span>
    <span class="n">ABSTRACTIVE</span> <span class="o">=</span> <span class="s2">&quot;abstractive&quot;</span>  <span class="c1"># 抽象式</span>
    <span class="n">HYBRID_GEN</span> <span class="o">=</span> <span class="s2">&quot;hybrid_gen&quot;</span>  <span class="c1"># 混合生成</span>
    <span class="n">CHAIN_OF_THOUGHT</span> <span class="o">=</span> <span class="s2">&quot;cot&quot;</span>  <span class="c1"># 思维链</span>
    <span class="n">SELF_CONSISTENCY</span> <span class="o">=</span> <span class="s2">&quot;self_consistency&quot;</span>  <span class="c1"># 自一致性</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">RAGQuality</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG质量级别&quot;&quot;&quot;</span>

    <span class="n">EXCELLENT</span> <span class="o">=</span> <span class="s2">&quot;excellent&quot;</span>
    <span class="n">GOOD</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
    <span class="n">FAIR</span> <span class="o">=</span> <span class="s2">&quot;fair&quot;</span>
    <span class="n">POOR</span> <span class="o">=</span> <span class="s2">&quot;poor&quot;</span>


<div class="viewcode-block" id="RetrievalConfig">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalConfig">[文档]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RetrievalConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;检索配置&quot;&quot;&quot;</span>

    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">min_similarity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># 添加缺失参数</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="n">RetrievalStrategy</span> <span class="o">=</span> <span class="n">RetrievalStrategy</span><span class="o">.</span><span class="n">SIMILARITY</span>
    <span class="n">enable_query_expansion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">expansion_terms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">enable_reranking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ranking_method</span><span class="p">:</span> <span class="n">RankingMethod</span> <span class="o">=</span> <span class="n">RankingMethod</span><span class="o">.</span><span class="n">COSINE_SIMILARITY</span>
    <span class="n">enable_filtering</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">filter_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span></div>



<div class="viewcode-block" id="GenerationConfig">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.GenerationConfig">[文档]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GenerationConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;生成配置&quot;&quot;&quot;</span>

    <span class="n">mode</span><span class="p">:</span> <span class="n">GenerationMode</span> <span class="o">=</span> <span class="n">GenerationMode</span><span class="o">.</span><span class="n">ABSTRACTIVE</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">enable_citation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">citation_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{source}</span><span class="s2">]&quot;</span>
    <span class="n">enable_fact_checking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quality_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span></div>



<div class="viewcode-block" id="RerankingConfig">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingConfig">[文档]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RerankingConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重排序配置&quot;&quot;&quot;</span>
    
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cross-encoder/ms-marco-MiniLM-L-6-v2&quot;</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span></div>



<div class="viewcode-block" id="RAGConfig">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGConfig">[文档]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG整体配置&quot;&quot;&quot;</span>

    <span class="n">mode</span><span class="p">:</span> <span class="n">RAGMode</span> <span class="o">=</span> <span class="n">RAGMode</span><span class="o">.</span><span class="n">ADAPTIVE</span>
    <span class="n">retrieval</span><span class="p">:</span> <span class="n">RetrievalConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">RetrievalConfig</span><span class="p">)</span>
    <span class="n">generation</span><span class="p">:</span> <span class="n">GenerationConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">GenerationConfig</span><span class="p">)</span>
    <span class="n">enable_caching</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cache_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="n">enable_monitoring</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    
    <span class="c1"># 测试配置支持的额外字段</span>
    <span class="n">vector_store_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;memory&quot;</span>
    <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;text-embedding-ada-002&quot;</span>
    <span class="n">embedding_dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1536</span>
    <span class="n">retrieval_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetrievalConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">reranking_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RerankingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_document_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 为了向后兼容，使用retrieval_config如果提供了的话</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrieval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_config</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reranking_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reranking_config</span> <span class="o">=</span> <span class="n">RerankingConfig</span><span class="p">()</span></div>



<div class="viewcode-block" id="RetrievalResult">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalResult">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RetrievalResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;检索结果&quot;&quot;&quot;</span>

    <span class="n">item</span><span class="p">:</span> <span class="n">Document</span>
    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></div>



<div class="viewcode-block" id="RAGResult">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGResult">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG最终结果&quot;&quot;&quot;</span>

    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span></div>



<div class="viewcode-block" id="QueryResult">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.QueryResult">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;查询结果&quot;&quot;&quot;</span>
    
    <span class="n">document</span><span class="p">:</span> <span class="n">Document</span>
    <span class="n">score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">retrieval_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;similarity&quot;</span></div>



<span class="c1"># ================================</span>
<span class="c1"># 核心接口定义</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="DocumentStore">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DocumentStore</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;文档存储抽象基类&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="DocumentStore.add_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore.add_document">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;添加文档&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="DocumentStore.get_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore.get_document">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取文档&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="DocumentStore.get_documents">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore.get_documents">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量获取文档&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="DocumentStore.delete_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore.delete_document">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;删除文档&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="DocumentStore.search_by_metadata">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.DocumentStore.search_by_metadata">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_by_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;按元数据搜索文档&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="VectorStore">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VectorStore</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;向量存储抽象基类&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="VectorStore.add_vectors">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore.add_vectors">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;添加向量&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="VectorStore.search">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore.search">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                    <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;搜索相似向量&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="VectorStore.delete">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore.delete">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;删除向量&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="VectorStore.get_statistics">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.VectorStore.get_statistics">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取统计信息&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="EmbeddingService">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.EmbeddingService">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmbeddingService</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;嵌入服务抽象基类&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="EmbeddingService.encode">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.EmbeddingService.encode">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;编码单个文本&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    
<div class="viewcode-block" id="EmbeddingService.encode_batch">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.EmbeddingService.encode_batch">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">encode_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量编码文本&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="Retriever">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Retriever">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Retriever</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;检索器抽象基类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Retriever.retrieve">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Retriever.retrieve">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetrievalConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;执行检索&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Retriever.expand_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Retriever.expand_query">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;查询扩展&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="Reranker">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Reranker">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Reranker</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重排序器抽象基类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Reranker.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Reranker.rerank">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重新排序检索结果&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="Generator">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Generator">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Generator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;生成器抽象基类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Generator.generate">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.Generator.generate">[文档]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成回答&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 服务类</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RetrievalService">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalService">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RetrievalService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;检索服务&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="RetrievalService.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalService.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetrievalConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span></div>

    
<div class="viewcode-block" id="RetrievalService.process_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalService.process_query">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;处理查询&quot;&quot;&quot;</span>
        <span class="c1"># 简单的查询预处理</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">processed</span></div>

    
<div class="viewcode-block" id="RetrievalService.filter_results">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RetrievalService.filter_results">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> 
                      <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;过滤结果&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="RerankingService">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingService">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RerankingService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;重排序服务&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="RerankingService.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingService.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RerankingConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span></div>

    
<div class="viewcode-block" id="RerankingService.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RerankingService.rerank">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重新排序结果&quot;&quot;&quot;</span>
        <span class="c1"># 简单的重排序实现</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="c1"># 模拟重排序分数</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rerank_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span>
        
        <span class="c1"># 按重排序分数排序</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rerank_score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 具体实现类</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="SimilarityRetriever">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.SimilarityRetriever">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimilarityRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于相似度的检索器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimilarityRetriever.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.SimilarityRetriever.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">KnowledgeBaseAdapter</span><span class="p">,</span> <span class="n">embedding_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">knowledge_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span> <span class="o">=</span> <span class="n">embedding_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 初始化嵌入模型</span>
        <span class="k">if</span> <span class="n">SENTENCE_TRANSFORMERS_AVAILABLE</span> <span class="ow">and</span> <span class="n">embedding_model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">embedding_model</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;无法加载嵌入模型 </span><span class="si">{</span><span class="n">embedding_model</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimilarityRetriever.retrieve">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.SimilarityRetriever.retrieve">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetrievalConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;基于相似度检索&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 获取查询嵌入</span>
            <span class="n">query_embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="c1"># 从知识库检索</span>
            <span class="n">similar_items</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span>
                <span class="n">query_embedding</span><span class="o">=</span><span class="n">query_embedding</span><span class="p">,</span>
                <span class="n">top_k</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_similarity</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># 转换为检索结果</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">similar_items</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;retrieval_method&quot;</span><span class="p">:</span> <span class="s2">&quot;similarity&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;embedding_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span><span class="p">,</span>
                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;检索失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="SimilarityRetriever.expand_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.SimilarityRetriever.expand_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;简单的查询扩展&quot;&quot;&quot;</span>
        <span class="c1"># 这里可以实现更复杂的查询扩展逻辑</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>

        <span class="c1"># 添加同义词或相关词</span>
        <span class="c1"># 这是一个简化的实现，实际可以使用词向量或语言模型</span>
        <span class="k">if</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">expanded</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取文本嵌入&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">([</span><span class="n">text</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取嵌入失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="CosineSimilarityReranker">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.CosineSimilarityReranker">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CosineSimilarityReranker</span><span class="p">(</span><span class="n">Reranker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;余弦相似度重排序器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CosineSimilarityReranker.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.CosineSimilarityReranker.rerank">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;基于余弦相似度重新排序&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SKLEARN_AVAILABLE</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 提取文本内容</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="c1"># 使用TF-IDF向量化</span>
            <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">tfidf_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="n">query</span><span class="p">]</span> <span class="o">+</span> <span class="n">texts</span><span class="p">)</span>

            <span class="c1"># 计算相似度</span>
            <span class="n">similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span>
                <span class="n">tfidf_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">tfidf_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="c1"># 重新排序</span>
            <span class="n">reranked_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">sim_score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">similarities</span><span class="p">)):</span>
                <span class="n">new_result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">sim_score</span><span class="p">,</span>
                    <span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;rerank_method&quot;</span><span class="p">:</span> <span class="s2">&quot;cosine_similarity&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">reranked_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_result</span><span class="p">)</span>

            <span class="c1"># 按分数排序</span>
            <span class="n">reranked_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 更新排名</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reranked_results</span><span class="p">):</span>
                <span class="n">reranked_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">reranked_results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;重排序失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span></div>
</div>



<div class="viewcode-block" id="PromptBasedGenerator">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.PromptBasedGenerator">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PromptBasedGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于提示的生成器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PromptBasedGenerator.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.PromptBasedGenerator.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">PromptEngine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">prompt_engine</span></div>


<div class="viewcode-block" id="PromptBasedGenerator.generate">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.PromptBasedGenerator.generate">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成基于上下文的回答&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 构建上下文</span>
            <span class="n">context_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="c1"># 构建提示模板</span>
            <span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context_text</span><span class="p">,</span>
                <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="s2">&quot;enable_citation&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_citation</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># 使用提示引擎生成回答</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span>
                <span class="n">template_name</span><span class="o">=</span><span class="s2">&quot;rag_generation&quot;</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">template_vars</span>
            <span class="p">)</span>

            <span class="c1"># 这里应该调用实际的语言模型</span>
            <span class="c1"># 暂时返回一个模拟的回答</span>
            <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;基于提供的上下文，</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2"> 的答案是：</span><span class="si">{</span><span class="n">context_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>

            <span class="c1"># 添加引用</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_citation</span><span class="p">:</span>
                <span class="n">citations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_citations</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">引用来源：</span><span class="si">{</span><span class="n">citations</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;生成回答失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;抱歉，无法生成合适的回答。&quot;</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建上下文文本&quot;&quot;&quot;</span>
        <span class="n">context_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[来源: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_citations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成引用&quot;&quot;&quot;</span>
        <span class="n">citations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">citation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">citation_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">citations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">citations</span><span class="p">)</span></div>



<span class="c1"># ================================</span>
<span class="c1"># 主要RAG引擎类 - 第一部分完成</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGEngine">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG引擎主类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RAGEngine.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RAGConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">KnowledgeBaseAdapter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CacheManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">performance_monitor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PerformanceMonitor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        初始化RAG引擎</span>

<span class="sd">        Args:</span>
<span class="sd">            config: RAG配置</span>
<span class="sd">            knowledge_base: 知识库实例（可选）</span>
<span class="sd">            prompt_engine: 提示引擎实例（可选）</span>
<span class="sd">            cache_manager: 缓存管理器</span>
<span class="sd">            performance_monitor: 性能监控器</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">knowledge_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">prompt_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">RAGConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_manager</span> <span class="o">=</span> <span class="n">cache_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_monitor</span> <span class="o">=</span> <span class="n">performance_monitor</span>

        <span class="c1"># 初始化组件（仅在依赖可用时）</span>
        <span class="k">if</span> <span class="n">knowledge_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="n">SimilarityRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">reranker</span> <span class="o">=</span> <span class="n">CosineSimilarityReranker</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">prompt_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">PromptBasedGenerator</span><span class="p">(</span><span class="n">prompt_engine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 统计信息</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;cache_hits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;avg_response_time&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="p">}</span>
        
        <span class="c1"># 初始化状态</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># 初始化内部服务（如果没有提供mock对象）</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_embedding_service&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_vector_store&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_document_store&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RAG引擎初始化完成&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RAGEngine.initialize">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.initialize">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;初始化RAG引擎&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;RAG引擎已经初始化&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 初始化各个组件</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="p">,</span> <span class="s1">&#39;initialize&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span><span class="p">,</span> <span class="s1">&#39;initialize&#39;</span><span class="p">):</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
                
            <span class="c1"># 标记为已初始化</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RAG引擎初始化完成&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RAG引擎初始化失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="RAGEngine.query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        主查询接口</span>

<span class="sd">        Args:</span>
<span class="sd">            question: 用户问题</span>
<span class="sd">            **kwargs: 额外参数</span>

<span class="sd">        Returns:</span>
<span class="sd">            RAGResult: RAG结果</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 性能监控开始</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_monitor</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_monitor</span><span class="o">.</span><span class="n">start_operation</span><span class="p">(</span><span class="s2">&quot;rag_query&quot;</span><span class="p">)</span>

            <span class="c1"># 检查缓存</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_caching</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_manager</span><span class="p">:</span>
                <span class="n">cached_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_from_cache</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cached_result</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cache_hits&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;缓存命中: </span><span class="si">{</span><span class="n">question</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">cached_result</span>

            <span class="c1"># 执行RAG流程</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_rag_pipeline</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># 更新统计信息</span>
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">(</span><span class="n">processing_time</span><span class="p">)</span>

            <span class="c1"># 缓存结果</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_caching</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_manager</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_result</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="c1"># 性能监控结束</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_monitor</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_monitor</span><span class="o">.</span><span class="n">end_operation</span><span class="p">(</span>
                    <span class="s2">&quot;rag_query&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RAG查询完成，耗时: </span><span class="si">{</span><span class="n">processing_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RAG查询失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="c1"># 返回错误结果</span>
            <span class="k">return</span> <span class="n">RAGResult</span><span class="p">(</span>
                <span class="n">response</span><span class="o">=</span><span class="s2">&quot;抱歉，处理您的问题时出现错误。&quot;</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">},</span>
                <span class="n">processing_time</span><span class="o">=</span><span class="n">processing_time</span><span class="p">,</span>
            <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_rag_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;执行RAG处理流程&quot;&quot;&quot;</span>
        <span class="c1"># 第一阶段：检索</span>
        <span class="n">retrieval_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_phase</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>

        <span class="c1"># 第二阶段：重排序</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">enable_reranking</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieval_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">retrieval_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rerank_phase</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>

        <span class="c1"># 第三阶段：生成回答</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generation_phase</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>

        <span class="c1"># 第四阶段：质量评估</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_quality</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>

        <span class="c1"># 构建最终结果</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">RAGResult</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">retrieval_results</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s2">&quot;retrieval_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieval_results</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="n">processing_time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 将在外层更新</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;检索阶段&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 查询扩展</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">question</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">enable_query_expansion</span><span class="p">:</span>
                <span class="n">expanded_queries</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="n">queries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">expanded_queries</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">expansion_terms</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># 对每个查询执行检索</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="p">)</span>
                <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

            <span class="c1"># 去重和合并</span>
            <span class="n">unique_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_retrieval_results</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>

            <span class="c1"># 过滤低质量结果</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">enable_filtering</span><span class="p">:</span>
                <span class="n">unique_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_results</span><span class="p">(</span><span class="n">unique_results</span><span class="p">)</span>

            <span class="c1"># 截取top-k</span>
            <span class="k">return</span> <span class="n">unique_results</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;检索阶段失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_rerank_phase</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重排序阶段&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reranker</span><span class="o">.</span><span class="n">rerank</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;重排序失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generation_phase</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成阶段&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">question</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">generation</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;生成阶段失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;抱歉，无法生成合适的回答。&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_quality</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;评估回答质量&quot;&quot;&quot;</span>
        <span class="c1"># 简单的质量评估逻辑</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># 基础置信度</span>

        <span class="c1"># 根据检索结果数量调整</span>
        <span class="k">if</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># 根据最高相似度分数调整</span>
        <span class="k">if</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">max_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">score</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">)</span>
            <span class="n">confidence</span> <span class="o">+=</span> <span class="n">max_score</span> <span class="o">*</span> <span class="mf">0.2</span>

        <span class="c1"># 根据回答长度调整（过短或过长都不好）</span>
        <span class="n">response_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">response_length</span> <span class="o">&lt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">+=</span> <span class="mf">0.1</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_retrieval_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;合并和去重检索结果&quot;&quot;&quot;</span>
        <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">unique_results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
                <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">unique_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># 按分数排序</span>
        <span class="n">unique_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 重新编号</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_results</span><span class="p">):</span>
            <span class="n">unique_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unique_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;过滤低质量结果&quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">filter_threshold</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成缓存键&quot;&quot;&quot;</span>
        <span class="n">key_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">key_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">key_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">key_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_from_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RAGResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;从缓存获取结果&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cached</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;缓存获取失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cache_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">RAGResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;缓存结果&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_manager</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;缓存存储失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;更新统计信息&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_queries&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># 计算平均响应时间</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_queries&quot;</span><span class="p">]</span>
        <span class="n">current_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;avg_response_time&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;avg_response_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current_avg</span> <span class="o">*</span> <span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">processing_time</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">total</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># 批量查询接口</span>
<div class="viewcode-block" id="RAGEngine.batch_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.batch_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batch_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RAGResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量查询接口&quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">questions</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">questions</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            <span class="n">batch_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">batch_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 处理异常</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_results</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">error_result</span> <span class="o">=</span> <span class="n">RAGResult</span><span class="p">(</span>
                        <span class="n">response</span><span class="o">=</span><span class="s2">&quot;批量处理时出现错误&quot;</span><span class="p">,</span>
                        <span class="n">sources</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">confidence</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="s2">&quot;batch_index&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">},</span>
                        <span class="n">processing_time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


    <span class="c1"># 流式查询接口（逐步返回结果）</span>
<div class="viewcode-block" id="RAGEngine.stream_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.stream_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;流式查询，逐步返回结果&quot;&quot;&quot;</span>
        <span class="c1"># 第一步：返回检索进度</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;retrieval&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;started&quot;</span><span class="p">}</span>

        <span class="n">retrieval_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_phase</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">{</span>
            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;retrieval&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;results_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieval_results</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># 第二步：重排序</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">enable_reranking</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieval_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;reranking&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;started&quot;</span><span class="p">}</span>
            <span class="n">retrieval_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rerank_phase</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;reranking&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">}</span>

        <span class="c1"># 第三步：生成</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;generation&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;started&quot;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generation_phase</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>

        <span class="c1"># 第四步：返回最终结果</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_quality</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">retrieval_results</span><span class="p">)</span>

        <span class="n">final_result</span> <span class="o">=</span> <span class="n">RAGResult</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">retrieval_results</span><span class="p">,</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">confidence</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="n">processing_time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;finished&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">final_result</span><span class="p">}</span></div>


    <span class="c1"># 配置管理</span>
<div class="viewcode-block" id="RAGEngine.update_config">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.update_config">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_config</span><span class="p">:</span> <span class="n">RAGConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;更新配置&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">new_config</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RAG引擎配置已更新&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RAGEngine.get_config">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.get_config">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取当前配置&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span></div>


    <span class="c1"># 统计信息接口</span>
<div class="viewcode-block" id="RAGEngine.get_stats">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.get_stats">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取统计信息&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="RAGEngine.reset_stats">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.reset_stats">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;重置统计信息&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;cache_hits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;avg_response_time&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="p">}</span></div>

    
    <span class="c1"># ================================</span>
    <span class="c1"># 文档管理方法</span>
    <span class="c1"># ================================</span>
    
<div class="viewcode-block" id="RAGEngine.add_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.add_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        添加单个文档到RAG系统</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            document: 要添加的文档</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: 文档ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 添加文档到文档存储</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">:</span>
                <span class="n">doc_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">doc_id</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            
            <span class="c1"># 生成文档嵌入</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="p">:</span>
                <span class="n">embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                
                <span class="c1"># 添加向量到向量存储</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="p">:</span>
                    <span class="n">vector_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                        <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span>
                        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">document</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="p">}</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="o">.</span><span class="n">add_vectors</span><span class="p">([</span><span class="n">vector_data</span><span class="p">])</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;成功添加文档: </span><span class="si">{</span><span class="n">doc_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">doc_id</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;添加文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RAGEngineError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;添加文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="RAGEngine.add_documents_batch">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.add_documents_batch">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_documents_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        批量添加文档</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            documents: 文档列表</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[str]: 文档ID列表</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">document_ids</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># 批量处理文档</span>
            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">:</span>
                <span class="n">doc_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                <span class="n">document_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
            
            <span class="c1"># 如果有批量嵌入服务，可以优化</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="p">,</span> <span class="s1">&#39;encode_batch&#39;</span><span class="p">):</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span><span class="o">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
                <span class="n">embeddings</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
                
                <span class="c1"># 批量更新向量（如果之前已经添加过）</span>
                <span class="c1"># 这里简化处理，实际可以优化</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;成功批量添加 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">document_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> 个文档&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">document_ids</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;批量添加文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RAGEngineError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;批量添加文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="RAGEngine.search">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.search">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                    <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">search_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;similarity&quot;</span><span class="p">,</span>
                    <span class="n">enable_reranking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        搜索文档</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query: 查询字符串</span>
<span class="sd">            top_k: 返回结果数量</span>
<span class="sd">            filters: 过滤条件</span>
<span class="sd">            search_type: 搜索类型 (similarity, semantic, hybrid)</span>
<span class="sd">            enable_reranking: 是否启用重排序</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[QueryResult]: 查询结果列表</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RAGEngineError</span><span class="p">(</span><span class="s2">&quot;嵌入服务或向量存储未初始化&quot;</span><span class="p">)</span>
            
            <span class="c1"># 获取查询嵌入</span>
            <span class="n">query_embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            
            <span class="c1"># 确定返回数量</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span>
            
            <span class="c1"># 执行向量搜索</span>
            <span class="n">vector_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">query_embedding</span><span class="p">,</span> 
                <span class="n">top_k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span>
            <span class="p">)</span>
            
            <span class="c1"># 获取文档内容</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vector_result</span> <span class="ow">in</span> <span class="n">vector_results</span><span class="p">:</span>
                <span class="n">doc_id</span> <span class="o">=</span> <span class="n">vector_result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">vector_result</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">vector_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>
                
                <span class="c1"># 从文档存储获取完整文档</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">:</span>
                    <span class="n">document</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">document</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">QueryResult</span><span class="p">(</span>
                            <span class="n">document</span><span class="o">=</span><span class="n">document</span><span class="p">,</span>
                            <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                            <span class="n">retrieval_method</span><span class="o">=</span><span class="n">search_type</span>
                        <span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            
            <span class="c1"># 应用重排序（如果启用）</span>
            <span class="k">if</span> <span class="n">enable_reranking</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reranking_service</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># 转换为字典格式进行重排序</span>
                <span class="n">rerank_input</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span>
                <span class="p">]</span>
                <span class="n">reranked</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reranking_service</span><span class="o">.</span><span class="n">rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">rerank_input</span><span class="p">)</span>
                
                <span class="c1"># 按重排序结果重新组织</span>
                <span class="n">reranked_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">reranked</span><span class="p">[:</span><span class="n">k</span><span class="p">]:</span>
                    <span class="c1"># 找到对应的QueryResult</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rr</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                            <span class="n">reranked_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">reranked_results</span>
            
            <span class="c1"># 过滤低分结果</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">similarity_threshold</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;搜索完成，返回 </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> 个结果&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;搜索失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RAGEngineError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;搜索失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="RAGEngine.update_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.update_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        更新文档</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            document_id: 文档ID</span>
<span class="sd">            content: 新内容</span>
<span class="sd">            metadata: 新元数据</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: 是否成功</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 获取现有文档</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">:</span>
                <span class="n">existing_doc</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_doc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;文档不存在: </span><span class="si">{</span><span class="n">document_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                
                <span class="c1"># 创建更新后的文档</span>
                <span class="n">updated_doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">existing_doc</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span> <span class="ow">or</span> <span class="n">existing_doc</span><span class="o">.</span><span class="n">metadata</span>
                <span class="p">)</span>
                
                <span class="c1"># 删除旧文档</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">delete_document</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
                
                <span class="c1"># 添加新文档</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">updated_doc</span><span class="p">)</span>
            
            <span class="c1"># 更新向量</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="p">:</span>
                <span class="n">embedding</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_service</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                <span class="n">vector_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">document_id</span><span class="p">,</span>
                    <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span>
                    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>
                <span class="p">}</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="o">.</span><span class="n">add_vectors</span><span class="p">([</span><span class="n">vector_data</span><span class="p">])</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;成功更新文档: </span><span class="si">{</span><span class="n">document_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;更新文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="RAGEngine.delete_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.delete_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        删除文档</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            document_id: 文档ID</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: 是否成功</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 从文档存储删除</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">delete_document</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
            
            <span class="c1"># 从向量存储删除</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;成功删除文档: </span><span class="si">{</span><span class="n">document_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;删除文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="RAGEngine.get_similar_documents">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.get_similar_documents">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_similar_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取与指定文档相似的文档</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            document_id: 参考文档ID</span>
<span class="sd">            top_k: 返回数量</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List[QueryResult]: 相似文档列表</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 获取参考文档</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RAGEngineError</span><span class="p">(</span><span class="s2">&quot;文档存储未初始化&quot;</span><span class="p">)</span>
            
            <span class="n">reference_doc</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_doc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;参考文档不存在: </span><span class="si">{</span><span class="n">document_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            
            <span class="c1"># 使用文档内容进行搜索</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">reference_doc</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># +1 因为结果中会包含自己</span>
                <span class="n">search_type</span><span class="o">=</span><span class="s2">&quot;similarity&quot;</span>
            <span class="p">)</span>
            
            <span class="c1"># 移除自己</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">document_id</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取相似文档失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    
<div class="viewcode-block" id="RAGEngine.get_statistics">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngine.get_statistics">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取RAG引擎统计信息</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: 统计信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_queries&quot;</span><span class="p">],</span>
                <span class="s2">&quot;cache_hits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;cache_hits&quot;</span><span class="p">],</span>
                <span class="s2">&quot;avg_response_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;avg_response_time&quot;</span><span class="p">],</span>
                <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">}</span>
            
            <span class="c1"># 添加向量存储统计</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="p">:</span>
                <span class="n">vector_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vector_store</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;total_vectors&quot;</span><span class="p">:</span> <span class="n">vector_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_vectors&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s2">&quot;dimension&quot;</span><span class="p">:</span> <span class="n">vector_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimension&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s2">&quot;index_size&quot;</span><span class="p">:</span> <span class="n">vector_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">})</span>
            
            <span class="c1"># 添加文档存储统计</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="p">,</span> <span class="s1">&#39;_documents&#39;</span><span class="p">):</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_documents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_document_store</span><span class="o">.</span><span class="n">_documents</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_documents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_vectors&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">stats</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取统计信息失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 高级排序和重排序实现</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="BM25Reranker">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.BM25Reranker">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BM25Reranker</span><span class="p">(</span><span class="n">Reranker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BM25重排序器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BM25Reranker.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.BM25Reranker.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">=</span> <span class="n">k1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corpus_stats</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BM25Reranker.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.BM25Reranker.rerank">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;基于BM25算法重新排序&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 提取文档内容</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="c1"># 计算BM25分数</span>
            <span class="n">bm25_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_bm25_scores</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">)</span>

            <span class="c1"># 重新排序</span>
            <span class="n">reranked_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">bm25_scores</span><span class="p">)):</span>
                <span class="n">new_result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;rerank_method&quot;</span><span class="p">:</span> <span class="s2">&quot;bm25&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">reranked_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_result</span><span class="p">)</span>

            <span class="c1"># 按分数排序</span>
            <span class="n">reranked_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 更新排名</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reranked_results</span><span class="p">):</span>
                <span class="n">reranked_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">reranked_results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BM25重排序失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_bm25_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算BM25分数&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SKLEARN_AVAILABLE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>

        <span class="c1"># 简单的分词（实际应用中应该使用更好的分词器）</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># 文档统计</span>
        <span class="n">doc_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
        <span class="n">avg_doc_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">doc_lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_lengths</span><span class="p">)</span> <span class="k">if</span> <span class="n">doc_lengths</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc_idx</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
            <span class="n">doc_terms</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">doc_length</span> <span class="o">=</span> <span class="n">doc_lengths</span><span class="p">[</span><span class="n">doc_idx</span><span class="p">]</span>

            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">query_terms</span><span class="p">:</span>
                <span class="c1"># 词频</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="n">doc_terms</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># 文档频率</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">docs</span> <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">idf</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">NUMPY_AVAILABLE</span>
                        <span class="k">else</span> <span class="mf">1.0</span>
                    <span class="p">)</span>

                    <span class="c1"># BM25计算</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">idf</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">tf</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="o">/</span> <span class="p">(</span>
                            <span class="n">tf</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k1</span>
                            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">doc_length</span> <span class="o">/</span> <span class="n">avg_doc_length</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>



<div class="viewcode-block" id="HybridReranker">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridReranker">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridReranker</span><span class="p">(</span><span class="n">Reranker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;混合重排序器，结合多种排序方法&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HybridReranker.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridReranker.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rerankers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Reranker</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rerankers</span> <span class="o">=</span> <span class="n">rerankers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="ow">or</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rerankers</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rerankers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;权重数量必须与重排序器数量一致&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HybridReranker.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridReranker.rerank">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;混合重排序&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 获取所有重排序器的结果</span>
            <span class="n">all_rankings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reranker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rerankers</span><span class="p">:</span>
                <span class="n">ranking</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reranker</span><span class="o">.</span><span class="n">rerank</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
                <span class="n">all_rankings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ranking</span><span class="p">)</span>

            <span class="c1"># 计算加权平均分数</span>
            <span class="n">combined_scores</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ranking</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_rankings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">ranking</span><span class="p">:</span>
                    <span class="n">combined_scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="n">weight</span>

            <span class="c1"># 构建最终结果</span>
            <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">avg_score</span> <span class="o">=</span> <span class="n">combined_scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">new_result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">avg_score</span><span class="p">,</span>
                    <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 临时设置</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;rerank_method&quot;</span><span class="p">:</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_result</span><span class="p">)</span>

            <span class="c1"># 按分数排序并更新排名</span>
            <span class="n">final_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_results</span><span class="p">):</span>
                <span class="n">final_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">final_results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;混合重排序失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span></div>
</div>



<div class="viewcode-block" id="ReciprocalRankFusionReranker">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ReciprocalRankFusionReranker">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReciprocalRankFusionReranker</span><span class="p">(</span><span class="n">Reranker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;互易排名融合重排序器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReciprocalRankFusionReranker.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ReciprocalRankFusionReranker.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span></div>


<div class="viewcode-block" id="ReciprocalRankFusionReranker.rerank">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ReciprocalRankFusionReranker.rerank">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rerank</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;RRF重排序&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 按原始分数排序</span>
            <span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 计算RRF分数</span>
            <span class="n">rrf_scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">rrf_scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">+</span> <span class="n">rank</span><span class="p">)</span>

            <span class="c1"># 构建新的结果</span>
            <span class="n">reranked_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">new_result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">rrf_scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                    <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 临时设置</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;rerank_method&quot;</span><span class="p">:</span> <span class="s2">&quot;rrf&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">reranked_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_result</span><span class="p">)</span>

            <span class="c1"># 按RRF分数排序</span>
            <span class="n">reranked_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 更新排名</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reranked_results</span><span class="p">):</span>
                <span class="n">reranked_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">reranked_results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RRF重排序失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 高级生成器实现</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="ChainOfThoughtGenerator">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ChainOfThoughtGenerator">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChainOfThoughtGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;思维链生成器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChainOfThoughtGenerator.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ChainOfThoughtGenerator.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">PromptEngine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">prompt_engine</span></div>


<div class="viewcode-block" id="ChainOfThoughtGenerator.generate">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.ChainOfThoughtGenerator.generate">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;基于思维链的生成&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 第一步：分析问题</span>
            <span class="n">analysis_prompt</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_analysis_prompt</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span><span class="n">analysis_prompt</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

            <span class="c1"># 第二步：逐步推理</span>
            <span class="n">reasoning_prompt</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_reasoning_prompt</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">analysis</span>
            <span class="p">)</span>
            <span class="n">reasoning</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span><span class="n">reasoning_prompt</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

            <span class="c1"># 第三步：生成最终答案</span>
            <span class="n">answer_prompt</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_answer_prompt</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">reasoning</span>
            <span class="p">)</span>
            <span class="n">final_answer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span>
                <span class="n">answer_prompt</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span>
            <span class="p">)</span>

            <span class="c1"># 组合完整回答</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_citation</span><span class="p">:</span>
                <span class="n">citations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_citations</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">full_response</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_answer</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">思考过程：</span><span class="se">\n</span><span class="si">{</span><span class="n">reasoning</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">引用来源：</span><span class="si">{</span><span class="n">citations</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_response</span> <span class="o">=</span> <span class="n">final_answer</span>

            <span class="k">return</span> <span class="n">full_response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;思维链生成失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;抱歉，生成过程中出现错误。&quot;</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_analysis_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建问题分析提示&quot;&quot;&quot;</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">[:</span><span class="mi">3</span><span class="p">])]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">分析以下问题和相关上下文：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">相关信息：</span>
<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">请简要分析这个问题的关键点和需要回答的核心内容：</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_reasoning_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">analysis</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建推理提示&quot;&quot;&quot;</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_context_text</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">基于以下信息进行逐步推理：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>
<span class="s2">分析：</span><span class="si">{</span><span class="n">analysis</span><span class="si">}</span>

<span class="s2">上下文信息：</span>
<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">请逐步推理，说明如何从提供的信息中得出答案：</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_build_answer_prompt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">analysis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reasoning</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建最终答案提示&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">基于前面的分析和推理，请给出问题的完整答案：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>
<span class="s2">分析：</span><span class="si">{</span><span class="n">analysis</span><span class="si">}</span>
<span class="s2">推理过程：</span><span class="si">{</span><span class="n">reasoning</span><span class="si">}</span>

<span class="s2">最终答案：</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_context_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建上下文文本&quot;&quot;&quot;</span>
        <span class="n">context_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [来源: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_citations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成引用&quot;&quot;&quot;</span>
        <span class="n">citations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">citation</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">citations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">citations</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;调用语言模型（模拟实现）&quot;&quot;&quot;</span>
        <span class="c1"># 这里应该调用实际的语言模型API</span>
        <span class="c1"># 暂时返回模拟响应</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;基于提示的模拟回答（长度限制：</span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">）&quot;</span></div>



<div class="viewcode-block" id="HybridGenerator">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridGenerator">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;混合生成器，结合抽取和生成&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HybridGenerator.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridGenerator.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">PromptEngine</span><span class="p">,</span> <span class="n">extract_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">prompt_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_ratio</span> <span class="o">=</span> <span class="n">extract_ratio</span></div>


<div class="viewcode-block" id="HybridGenerator.generate">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridGenerator.generate">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;混合生成方式&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 抽取式部分：直接从上下文中提取相关片段</span>
            <span class="n">extracted_parts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_relevant_parts</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

            <span class="c1"># 生成式部分：基于上下文生成新内容</span>
            <span class="n">generated_part</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_new_content</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="c1"># 合并结果</span>
            <span class="k">if</span> <span class="n">extracted_parts</span> <span class="ow">and</span> <span class="n">generated_part</span><span class="p">:</span>
                <span class="n">combined_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">generated_part</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">相关信息：</span><span class="se">\n</span><span class="si">{</span><span class="n">extracted_parts</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">extracted_parts</span><span class="p">:</span>
                <span class="n">combined_response</span> <span class="o">=</span> <span class="n">extracted_parts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_response</span> <span class="o">=</span> <span class="n">generated_part</span> <span class="ow">or</span> <span class="s2">&quot;无法生成合适的回答。&quot;</span>

            <span class="c1"># 添加引用</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_citation</span><span class="p">:</span>
                <span class="n">citations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_citations</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                <span class="n">combined_response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">引用来源：</span><span class="si">{</span><span class="n">citations</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="n">combined_response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;混合生成失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;抱歉，生成过程中出现错误。&quot;</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_extract_relevant_parts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;抽取相关部分&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># 简单的抽取逻辑：选择最相关的片段</span>
        <span class="n">query_terms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="n">relevant_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span>
            <span class="n">content_terms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

            <span class="c1"># 计算重叠度</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_terms</span> <span class="o">&amp;</span> <span class="n">content_terms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># 提取包含查询词的句子</span>
                <span class="n">sentences</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;。&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">term</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">query_terms</span><span class="p">):</span>
                        <span class="n">relevant_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relevant_parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>  <span class="c1"># 限制数量</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_new_content</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成新内容&quot;&quot;&quot;</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">150</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">context</span><span class="p">[:</span><span class="mi">3</span><span class="p">]])</span>

        <span class="c1"># 构建生成提示</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">基于以下信息回答问题：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">相关信息：</span>
<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">请生成一个综合性的回答（</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span><span class="si">}</span><span class="s2">字以内）：</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="c1"># 模拟LLM调用</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;调用语言模型&quot;&quot;&quot;</span>
        <span class="c1"># 模拟实现</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;基于上下文的综合回答（最大长度：</span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">字）&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_citations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成引用&quot;&quot;&quot;</span>
        <span class="n">citations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">citation</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">citation_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">citations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">citations</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span></div>



<div class="viewcode-block" id="FactCheckingGenerator">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.FactCheckingGenerator">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FactCheckingGenerator</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;事实核查生成器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FactCheckingGenerator.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.FactCheckingGenerator.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">PromptEngine</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">KnowledgeBaseAdapter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">prompt_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">knowledge_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact_cache</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="FactCheckingGenerator.generate">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.FactCheckingGenerator.generate">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;带事实核查的生成&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 第一步：生成初始回答</span>
            <span class="n">initial_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_initial_response</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">config</span>
            <span class="p">)</span>

            <span class="c1"># 第二步：提取声明进行事实核查</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">enable_fact_checking</span><span class="p">:</span>
                <span class="n">fact_check_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fact_check_response</span><span class="p">(</span>
                    <span class="n">initial_response</span><span class="p">,</span> <span class="n">query</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">fact_check_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">quality_threshold</span><span class="p">:</span>
                    <span class="c1"># 重新生成更保守的回答</span>
                    <span class="n">conservative_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_conservative_response</span><span class="p">(</span>
                        <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fact_check_result</span><span class="p">[</span><span class="s2">&quot;issues&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">conservative_response</span>

            <span class="k">return</span> <span class="n">initial_response</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;事实核查生成失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;抱歉，生成过程中出现错误。&quot;</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_initial_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成初始回答&quot;&quot;&quot;</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_context_text</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">基于以下可靠信息回答问题：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">信息来源：</span>
<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">要求：</span>
<span class="s2">- 答案要基于提供的信息</span>
<span class="s2">- 避免过度推测</span>
<span class="s2">- 如果信息不足，要明确说明</span>
<span class="s2">- 最大长度：</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span><span class="si">}</span><span class="s2">字</span>

<span class="s2">回答：</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fact_check_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;对回答进行事实核查&quot;&quot;&quot;</span>
        <span class="c1"># 简化的事实核查逻辑</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># 检查是否包含不确定性词汇</span>
        <span class="n">uncertainty_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;可能&quot;</span><span class="p">,</span> <span class="s2">&quot;也许&quot;</span><span class="p">,</span> <span class="s2">&quot;大概&quot;</span><span class="p">,</span> <span class="s2">&quot;应该&quot;</span><span class="p">,</span> <span class="s2">&quot;据说&quot;</span><span class="p">]</span>
        <span class="n">uncertainty_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="mi">1</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">uncertainty_markers</span> <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">response</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">uncertainty_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">-=</span> <span class="n">uncertainty_count</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;包含</span><span class="si">{</span><span class="n">uncertainty_count</span><span class="si">}</span><span class="s2">个不确定性表述&quot;</span><span class="p">)</span>

        <span class="c1"># 检查回答长度是否合理</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">-=</span> <span class="mf">0.2</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;回答过于简短&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">-=</span> <span class="mf">0.1</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;回答过于冗长&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">issues</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_conservative_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">issues</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成保守的回答&quot;&quot;&quot;</span>
        <span class="n">context_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_context_text</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">基于以下信息谨慎回答问题（发现的问题：</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span><span class="si">}</span><span class="s2">）：</span>

<span class="s2">问题：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span>

<span class="s2">可用信息：</span>
<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">请提供一个保守、准确的回答，如果信息不足请明确说明：</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_llm</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_context_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;构建上下文文本&quot;&quot;&quot;</span>
        <span class="n">context_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. 来源：</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="se">\n</span><span class="s2">   内容：</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_call_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;调用语言模型&quot;&quot;&quot;</span>
        <span class="c1"># 模拟实现</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;经过事实核查的保守回答（最大长度：</span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2">字）&quot;</span></div>



<span class="c1"># ================================</span>
<span class="c1"># RAG引擎工厂和管理器</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGEngineFactory">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngineFactory">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGEngineFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG引擎工厂类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RAGEngineFactory.create_engine">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGEngineFactory.create_engine">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_engine</span><span class="p">(</span>
        <span class="n">engine_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">KnowledgeBaseAdapter</span><span class="p">,</span>
        <span class="n">prompt_engine</span><span class="p">:</span> <span class="n">PromptEngine</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RAGConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGEngine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;创建RAG引擎实例&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">RAGConfig</span><span class="p">()</span>

        <span class="c1"># 根据类型选择组件</span>
        <span class="k">if</span> <span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;basic&quot;</span><span class="p">:</span>
            <span class="n">retriever</span> <span class="o">=</span> <span class="n">SimilarityRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
            <span class="n">reranker</span> <span class="o">=</span> <span class="n">CosineSimilarityReranker</span><span class="p">()</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">PromptBasedGenerator</span><span class="p">(</span><span class="n">prompt_engine</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;advanced&quot;</span><span class="p">:</span>
            <span class="c1"># 混合检索器</span>
            <span class="n">similarity_retriever</span> <span class="o">=</span> <span class="n">SimilarityRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
            <span class="n">keyword_retriever</span> <span class="o">=</span> <span class="n">KeywordRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
            <span class="n">retriever</span> <span class="o">=</span> <span class="n">HybridRetriever</span><span class="p">([</span><span class="n">similarity_retriever</span><span class="p">,</span> <span class="n">keyword_retriever</span><span class="p">])</span>

            <span class="c1"># 混合重排序器</span>
            <span class="n">cosine_reranker</span> <span class="o">=</span> <span class="n">CosineSimilarityReranker</span><span class="p">()</span>
            <span class="n">bm25_reranker</span> <span class="o">=</span> <span class="n">BM25Reranker</span><span class="p">()</span>
            <span class="n">reranker</span> <span class="o">=</span> <span class="n">HybridReranker</span><span class="p">([</span><span class="n">cosine_reranker</span><span class="p">,</span> <span class="n">bm25_reranker</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>

            <span class="c1"># 思维链生成器</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">ChainOfThoughtGenerator</span><span class="p">(</span><span class="n">prompt_engine</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;enterprise&quot;</span><span class="p">:</span>
            <span class="c1"># 企业级配置</span>
            <span class="n">similarity_retriever</span> <span class="o">=</span> <span class="n">SimilarityRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
            <span class="n">keyword_retriever</span> <span class="o">=</span> <span class="n">KeywordRetriever</span><span class="p">(</span><span class="n">knowledge_base</span><span class="p">)</span>
            <span class="n">retriever</span> <span class="o">=</span> <span class="n">HybridRetriever</span><span class="p">([</span><span class="n">similarity_retriever</span><span class="p">,</span> <span class="n">keyword_retriever</span><span class="p">])</span>

            <span class="c1"># RRF重排序</span>
            <span class="n">reranker</span> <span class="o">=</span> <span class="n">ReciprocalRankFusionReranker</span><span class="p">()</span>

            <span class="c1"># 事实核查生成器</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">FactCheckingGenerator</span><span class="p">(</span><span class="n">prompt_engine</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的引擎类型: </span><span class="si">{</span><span class="n">engine_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 创建引擎</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">RAGEngine</span><span class="p">(</span>
            <span class="n">knowledge_base</span><span class="o">=</span><span class="n">knowledge_base</span><span class="p">,</span>
            <span class="n">prompt_engine</span><span class="o">=</span><span class="n">prompt_engine</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 设置组件</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="n">retriever</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">reranker</span> <span class="o">=</span> <span class="n">reranker</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">generator</span>

        <span class="k">return</span> <span class="n">engine</span></div>
</div>



<div class="viewcode-block" id="KeywordRetriever">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.KeywordRetriever">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KeywordRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于关键词的检索器实现&quot;&quot;&quot;</span>

<div class="viewcode-block" id="KeywordRetriever.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.KeywordRetriever.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">knowledge_base</span><span class="p">:</span> <span class="n">KnowledgeBaseAdapter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_base</span> <span class="o">=</span> <span class="n">knowledge_base</span></div>


<div class="viewcode-block" id="KeywordRetriever.retrieve">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.KeywordRetriever.retrieve">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetrievalConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;关键词检索实现&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 简化实现，实际应该调用知识库的关键词检索方法</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_keywords</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># 这里是模拟实现</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
                <span class="c1"># 创建模拟的知识项</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.knowledge_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>

                <span class="n">item</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;keyword_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;基于关键词&#39;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;找到的相关内容 </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;keyword_source_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{},</span>
                <span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="mf">0.8</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">rank</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;retrieval_method&quot;</span><span class="p">:</span> <span class="s2">&quot;keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;keywords&quot;</span><span class="p">:</span> <span class="n">keywords</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;关键词检索失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="KeywordRetriever.expand_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.KeywordRetriever.expand_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;关键词查询扩展&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>  <span class="c1"># 简化实现</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;提取关键词&quot;&quot;&quot;</span>
        <span class="c1"># 简单的关键词提取</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1"># 过滤停用词</span>
        <span class="n">stopwords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;的&quot;</span><span class="p">,</span> <span class="s2">&quot;是&quot;</span><span class="p">,</span> <span class="s2">&quot;在&quot;</span><span class="p">,</span> <span class="s2">&quot;有&quot;</span><span class="p">,</span> <span class="s2">&quot;和&quot;</span><span class="p">,</span> <span class="s2">&quot;或&quot;</span><span class="p">,</span> <span class="s2">&quot;但是&quot;</span><span class="p">,</span> <span class="s2">&quot;如果&quot;</span><span class="p">,</span> <span class="s2">&quot;那么&quot;</span><span class="p">}</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stopwords</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">keywords</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span></div>



<span class="c1"># ================================</span>
<span class="c1"># 性能优化和监控组件</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGPerformanceOptimizer">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGPerformanceOptimizer">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGPerformanceOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG性能优化器&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RAGPerformanceOptimizer.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGPerformanceOptimizer.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rag_engine</span><span class="p">:</span> <span class="n">RAGEngine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span> <span class="o">=</span> <span class="n">rag_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_rules</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="RAGPerformanceOptimizer.optimize_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGPerformanceOptimizer.optimize_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">optimize_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;优化查询执行&quot;&quot;&quot;</span>
        <span class="c1"># 记录开始时间</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 预处理优化</span>
            <span class="n">optimized_query</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="c1"># 智能缓存检查</span>
            <span class="n">cache_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smart_cache_lookup</span><span class="p">(</span><span class="n">optimized_query</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cache_result</span>

            <span class="c1"># 动态配置调整</span>
            <span class="n">optimized_config</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_config_for_query</span><span class="p">(</span><span class="n">optimized_query</span><span class="p">)</span>

            <span class="c1"># 执行查询</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">optimized_query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># 记录性能数据</span>
            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_performance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">)</span>

            <span class="c1"># 缓存结果</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smart_cache_store</span><span class="p">(</span><span class="n">optimized_query</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;优化查询失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;预处理查询&quot;&quot;&quot;</span>
        <span class="c1"># 清理和标准化查询</span>
        <span class="n">cleaned_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># 去除重复空格</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="n">cleaned_query</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">cleaned_query</span><span class="p">)</span>

        <span class="c1"># 简单的同义词替换</span>
        <span class="n">synonyms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;怎么&quot;</span><span class="p">:</span> <span class="s2">&quot;如何&quot;</span><span class="p">,</span> <span class="s2">&quot;什么是&quot;</span><span class="p">:</span> <span class="s2">&quot;什么&quot;</span><span class="p">,</span> <span class="s2">&quot;怎样&quot;</span><span class="p">:</span> <span class="s2">&quot;如何&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">replacement</span> <span class="ow">in</span> <span class="n">synonyms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">original</span> <span class="ow">in</span> <span class="n">cleaned_query</span><span class="p">:</span>
                <span class="n">cleaned_query</span> <span class="o">=</span> <span class="n">cleaned_query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cleaned_query</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_smart_cache_lookup</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RAGResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;智能缓存查找&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_caching</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 生成缓存键</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 查找完全匹配</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">:</span>
            <span class="n">cached_result</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

            <span class="c1"># 检查是否过期</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;缓存命中: </span><span class="si">{</span><span class="n">query</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cached_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 删除过期缓存</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="c1"># 查找相似查询</span>
        <span class="n">similar_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_similar_cached_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">similar_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">similar_result</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_find_similar_cached_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RAGResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;查找相似的缓存查询&quot;&quot;&quot;</span>
        <span class="n">query_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">best_match</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_similarity</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="n">cached_result</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 检查是否过期</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># 从缓存键解析查询（简化实现）</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cached_query_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="n">cached_query</span> <span class="o">=</span> <span class="n">cached_query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">cached_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cached_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

                <span class="c1"># 计算相似度</span>
                <span class="k">if</span> <span class="n">cached_words</span> <span class="ow">and</span> <span class="n">query_words</span><span class="p">:</span>
                    <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span> <span class="o">&amp;</span> <span class="n">cached_words</span><span class="p">)</span>
                    <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span> <span class="o">|</span> <span class="n">cached_words</span><span class="p">)</span>
                    <span class="n">similarity</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>

                    <span class="c1"># 如果相似度足够高，使用缓存结果</span>
                    <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="ow">and</span> <span class="n">similarity</span> <span class="o">&gt;</span> <span class="n">best_similarity</span><span class="p">:</span>
                        <span class="n">best_similarity</span> <span class="o">=</span> <span class="n">similarity</span>
                        <span class="n">best_match</span> <span class="o">=</span> <span class="n">cached_result</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">best_match</span> <span class="ow">and</span> <span class="n">best_similarity</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;找到相似缓存查询，相似度: </span><span class="si">{</span><span class="n">best_similarity</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">best_match</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_adjust_config_for_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;根据查询动态调整配置&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span>

        <span class="c1"># 根据查询长度调整</span>
        <span class="n">query_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query_length</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># 长查询</span>
            <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">max_length</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query_length</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>  <span class="c1"># 短查询</span>
            <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="c1"># 根据查询类型调整</span>
        <span class="k">if</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;如何&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;怎么&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>  <span class="c1"># 问答类型</span>
            <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">enable_query_expansion</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GenerationMode</span><span class="o">.</span><span class="n">CHAIN_OF_THOUGHT</span>
        <span class="k">elif</span> <span class="s2">&quot;列举&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;有哪些&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>  <span class="c1"># 列举类型</span>
            <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GenerationMode</span><span class="o">.</span><span class="n">EXTRACTIVE</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_record_performance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">RAGResult</span><span class="p">,</span> <span class="n">execution_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;记录性能数据&quot;&quot;&quot;</span>
        <span class="n">performance_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;execution_time&quot;</span><span class="p">:</span> <span class="n">execution_time</span><span class="p">,</span>
            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
            <span class="s2">&quot;sources_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">),</span>
            <span class="s2">&quot;response_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">performance_data</span><span class="p">)</span>

        <span class="c1"># 检查是否需要优化建议</span>
        <span class="k">if</span> <span class="n">execution_time</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>  <span class="c1"># 超过5秒</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;查询执行时间过长: </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s - </span><span class="si">{</span><span class="n">query</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># 置信度过低</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;查询置信度过低: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">query</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_smart_cache_store</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">RAGResult</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;智能缓存存储&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_caching</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># 只缓存高质量结果</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;=</span> <span class="mf">0.6</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cache_key</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

            <span class="c1"># 限制缓存大小</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="c1"># 删除最旧的缓存项</span>
                <span class="n">oldest_key</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;生成缓存键&quot;&quot;&quot;</span>
        <span class="n">cache_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
            <span class="s2">&quot;config_hash&quot;</span><span class="p">:</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rag_engine</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cache_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="RAGPerformanceOptimizer.get_performance_stats">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGPerformanceOptimizer.get_performance_stats">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_performance_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取性能统计信息&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">execution_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;execution_time&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">]</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;total_queries&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">),</span>
            <span class="s2">&quot;avg_execution_time&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">execution_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">execution_times</span><span class="p">),</span>
            <span class="s2">&quot;max_execution_time&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">execution_times</span><span class="p">),</span>
            <span class="s2">&quot;min_execution_time&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">execution_times</span><span class="p">),</span>
            <span class="s2">&quot;avg_confidence&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidences</span><span class="p">),</span>
            <span class="s2">&quot;cache_hit_rate&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_cache</span><span class="p">)</span>
            <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_history</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 高级混合检索器实现</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="HybridRetriever">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridRetriever">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridRetriever</span><span class="p">(</span><span class="n">Retriever</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;混合检索器，结合多种检索策略&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HybridRetriever.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridRetriever.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retrievers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Retriever</span><span class="p">],</span> <span class="n">fusion_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rrf&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrievers</span> <span class="o">=</span> <span class="n">retrievers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_method</span> <span class="o">=</span> <span class="n">fusion_method</span></div>


<div class="viewcode-block" id="HybridRetriever.retrieve">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridRetriever.retrieve">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RetrievalConfig</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;混合检索&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 从所有检索器获取结果</span>
            <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">retrieval_tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">retriever</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">retriever</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrievers</span>
            <span class="p">]</span>

            <span class="n">retriever_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="n">retrieval_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># 处理结果</span>
            <span class="k">for</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">retriever_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">all_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

            <span class="c1"># 融合结果</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_method</span> <span class="o">==</span> <span class="s2">&quot;rrf&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rrf_fusion</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion_method</span> <span class="o">==</span> <span class="s2">&quot;score_avg&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_average_fusion</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_fusion</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;混合检索失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="HybridRetriever.expand_query">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.HybridRetriever.expand_query">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">expand_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;查询扩展，使用所有检索器的扩展结果&quot;&quot;&quot;</span>
        <span class="n">all_expansions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">query</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">retriever</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrievers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expansions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retriever</span><span class="o">.</span><span class="n">expand_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">all_expansions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">expansions</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;查询扩展失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_expansions</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_rrf_fusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;RRF融合&quot;&quot;&quot;</span>
        <span class="c1"># 按检索器分组</span>
        <span class="n">retriever_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">retriever_name</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retrieval_method&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="n">retriever_groups</span><span class="p">[</span><span class="n">retriever_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># 计算RRF分数</span>
        <span class="n">rrf_scores</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="k">for</span> <span class="n">group_results</span> <span class="ow">in</span> <span class="n">retriever_groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">rrf_scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">rank</span><span class="p">)</span>

        <span class="c1"># 去重并创建最终结果</span>
        <span class="n">unique_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_results</span><span class="p">:</span>
                <span class="n">unique_results</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">rrf_scores</span><span class="p">[</span><span class="n">item_id</span><span class="p">],</span>
                    <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;fusion_method&quot;</span><span class="p">:</span> <span class="s2">&quot;rrf&quot;</span><span class="p">},</span>
                <span class="p">)</span>

        <span class="c1"># 排序并截取</span>
        <span class="n">final_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">final_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 更新排名</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]):</span>
            <span class="n">final_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_score_average_fusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;分数平均融合&quot;&quot;&quot;</span>
        <span class="c1"># 按项目ID分组</span>
        <span class="n">score_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">item_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">score_groups</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
            <span class="n">item_map</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span>

        <span class="c1"># 计算平均分数</span>
        <span class="n">averaged_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item_id</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">score_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">avg_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">RetrievalResult</span><span class="p">(</span>
                <span class="n">item</span><span class="o">=</span><span class="n">item_map</span><span class="p">[</span><span class="n">item_id</span><span class="p">],</span>
                <span class="n">score</span><span class="o">=</span><span class="n">avg_score</span><span class="p">,</span>
                <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fusion_method&quot;</span><span class="p">:</span> <span class="s2">&quot;score_average&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">averaged_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># 排序并更新排名</span>
        <span class="n">averaged_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">averaged_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]):</span>
            <span class="n">averaged_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">averaged_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_simple_fusion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;简单融合，去重并按原始分数排序&quot;&quot;&quot;</span>
        <span class="c1"># 去重</span>
        <span class="n">unique_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">item_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">item_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_results</span>
                <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">unique_results</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span><span class="o">.</span><span class="n">score</span>
            <span class="p">):</span>
                <span class="n">unique_results</span><span class="p">[</span><span class="n">item_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># 排序</span>
        <span class="n">final_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">final_results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 更新排名</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]):</span>
            <span class="n">final_results</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span></div>



<span class="c1"># ================================</span>
<span class="c1"># 辅助工具和实用方法</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="RAGUtils">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RAGUtils</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;RAG工具类&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RAGUtils.create_default_config">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils.create_default_config">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_default_config</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n">RAGMode</span> <span class="o">=</span> <span class="n">RAGMode</span><span class="o">.</span><span class="n">ADAPTIVE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RAGConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;创建默认配置&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RAGConfig</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">retrieval</span><span class="o">=</span><span class="n">RetrievalConfig</span><span class="p">(</span>
                <span class="n">top_k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">min_similarity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">strategy</span><span class="o">=</span><span class="n">RetrievalStrategy</span><span class="o">.</span><span class="n">HYBRID_SEARCH</span><span class="p">,</span>
                <span class="n">enable_query_expansion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">enable_reranking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ranking_method</span><span class="o">=</span><span class="n">RankingMethod</span><span class="o">.</span><span class="n">HYBRID_RANKING</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">generation</span><span class="o">=</span><span class="n">GenerationConfig</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">GenerationMode</span><span class="o">.</span><span class="n">ABSTRACTIVE</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                <span class="n">enable_citation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">enable_fact_checking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">enable_caching</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enable_monitoring</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RAGUtils.validate_config">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils.validate_config">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">RAGConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;验证配置&quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 检查检索配置</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">top_k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;retrieval.top_k 必须大于 0&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">retrieval</span><span class="o">.</span><span class="n">min_similarity</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;retrieval.min_similarity 必须在 0.0 到 1.0 之间&quot;</span><span class="p">)</span>

        <span class="c1"># 检查生成配置</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">max_length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;generation.max_length 必须大于 0&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">generation</span><span class="o">.</span><span class="n">temperature</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">):</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;generation.temperature 必须在 0.0 到 2.0 之间&quot;</span><span class="p">)</span>

        <span class="c1"># 检查缓存配置</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;cache_ttl 必须大于 0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">issues</span></div>


<div class="viewcode-block" id="RAGUtils.calculate_retrieval_metrics">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils.calculate_retrieval_metrics">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_retrieval_metrics</span><span class="p">(</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RetrievalResult</span><span class="p">],</span> <span class="n">ground_truth</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;计算检索指标&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="n">retrieved_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
        <span class="n">ground_truth_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span>

        <span class="c1"># 计算精确率、召回率和F1分数</span>
        <span class="n">true_positives</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_ids</span> <span class="o">&amp;</span> <span class="n">ground_truth_set</span><span class="p">)</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="n">true_positives</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">retrieved_ids</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="n">true_positives</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth_set</span><span class="p">)</span> <span class="k">if</span> <span class="n">ground_truth_set</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
            <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
            <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
            <span class="s2">&quot;true_positives&quot;</span><span class="p">:</span> <span class="n">true_positives</span><span class="p">,</span>
            <span class="s2">&quot;retrieved_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">retrieved_ids</span><span class="p">),</span>
            <span class="s2">&quot;ground_truth_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth_set</span><span class="p">),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="RAGUtils.format_rag_result">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils.format_rag_result">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_rag_result</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">RAGResult</span><span class="p">,</span> <span class="n">include_sources</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;格式化RAG结果为可读文本&quot;&quot;&quot;</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;回答：</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;置信度：</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;处理时间：</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">processing_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">秒</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">include_sources</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">检索到的相关信息（</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span><span class="si">}</span><span class="s2">条）：</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. [</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">] (相关度: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">formatted</span></div>


<div class="viewcode-block" id="RAGUtils.export_rag_results">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.RAGUtils.export_rag_results">[文档]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_rag_results</span><span class="p">(</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RAGResult</span><span class="p">],</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;导出RAG结果&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># 转换为可序列化格式</span>
                <span class="n">serializable_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">serializable_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
                        <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">processing_time</span><span class="p">,</span>
                        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                        <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                                <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span>
                                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                            <span class="p">}</span>
                            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">sources</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">serializable_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serializable_result</span><span class="p">)</span>

                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">serializable_results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="c1"># 写入表头</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="s2">&quot;Confidence&quot;</span><span class="p">,</span> <span class="s2">&quot;Processing Time&quot;</span><span class="p">,</span> <span class="s2">&quot;Sources Count&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># 写入数据</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span>
                            <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">processing_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">sources</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;不支持的导出格式: </span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 具体存储实现类（用于测试）</span>
<span class="c1"># ================================</span>


<div class="viewcode-block" id="MemoryDocumentStore">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MemoryDocumentStore</span><span class="p">(</span><span class="n">DocumentStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;内存文档存储实现&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="MemoryDocumentStore.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Document</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    
<div class="viewcode-block" id="MemoryDocumentStore.add_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.add_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;添加文档&quot;&quot;&quot;</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="c1"># 创建带ID的新文档</span>
        <span class="n">new_doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_doc</span>
        <span class="k">return</span> <span class="n">doc_id</span></div>

    
<div class="viewcode-block" id="MemoryDocumentStore.get_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.get_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取文档&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="MemoryDocumentStore.get_documents">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.get_documents">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量获取文档&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">[</span><span class="n">doc_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="n">document_ids</span> 
                <span class="k">if</span> <span class="n">doc_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="MemoryDocumentStore.delete_document">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.delete_document">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;删除文档&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">document_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="p">[</span><span class="n">document_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="MemoryDocumentStore.search_by_metadata">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryDocumentStore.search_by_metadata">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_by_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;按元数据搜索文档&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_documents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>
</div>



<div class="viewcode-block" id="MemoryVectorStore">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MemoryVectorStore</span><span class="p">(</span><span class="n">VectorStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;内存向量存储实现&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="MemoryVectorStore.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span></div>

    
<div class="viewcode-block" id="MemoryVectorStore.add_vectors">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore.add_vectors">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">add_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;添加向量&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vector_data</span> <span class="ow">in</span> <span class="n">vectors</span><span class="p">:</span>
                <span class="n">vector_id</span> <span class="o">=</span> <span class="n">vector_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="n">vector_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector_data</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="MemoryVectorStore.search">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore.search">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                    <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;搜索相似向量&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NUMPY_AVAILABLE</span><span class="p">:</span>
            <span class="c1"># 返回模拟结果</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;vec_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="p">]</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vector_id</span><span class="p">,</span> <span class="n">vector_data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 应用过滤器</span>
            <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">continue</span>
            
            <span class="c1"># 计算相似度</span>
            <span class="n">stored_vector</span> <span class="o">=</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stored_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># 计算余弦相似度</span>
                <span class="n">similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">query_vector</span><span class="p">,</span> <span class="n">stored_vector</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">query_vector</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">stored_vector</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">vector_id</span><span class="p">,</span>
                    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">similarity</span><span class="p">),</span>
                    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">vector_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="p">})</span>
        
        <span class="c1"># 按分数排序并返回top_k</span>
        <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="MemoryVectorStore.delete">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore.delete">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;删除向量&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vector_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">[</span><span class="n">vector_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="MemoryVectorStore.get_statistics">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MemoryVectorStore.get_statistics">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;获取统计信息&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;total_vectors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">),</span>
            <span class="s2">&quot;dimension&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">,</span>
            <span class="s2">&quot;index_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vectors</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># 假设float32</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="MockEmbeddingService">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MockEmbeddingService">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MockEmbeddingService</span><span class="p">(</span><span class="n">EmbeddingService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;模拟嵌入服务实现&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="MockEmbeddingService.__init__">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MockEmbeddingService.__init__">[文档]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>
        <span class="c1"># 为了一致性，使用固定种子</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="k">if</span> <span class="n">NUMPY_AVAILABLE</span> <span class="k">else</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="MockEmbeddingService.encode">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MockEmbeddingService.encode">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;编码单个文本&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NUMPY_AVAILABLE</span><span class="p">:</span>
            <span class="c1"># 返回模拟向量</span>
            <span class="k">return</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span>
        
        <span class="c1"># 基于文本内容生成确定性向量</span>
        <span class="n">text_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">text_hash</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">))</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">)</span>
        <span class="c1"># 归一化</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="MockEmbeddingService.encode_batch">
<a class="viewcode-back" href="../../../../api/adapters.html#zishu.adapters.soft.rag_engine.MockEmbeddingService.encode_batch">[文档]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">encode_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;批量编码文本&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span></div>
</div>



<span class="c1"># ================================</span>
<span class="c1"># 主要导出接口</span>
<span class="c1"># ================================</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># 核心类</span>
    <span class="s2">&quot;RAGEngine&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RAGConfig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RetrievalConfig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GenerationConfig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RerankingConfig&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RAGResult&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RetrievalResult&quot;</span><span class="p">,</span>
    <span class="s2">&quot;QueryResult&quot;</span><span class="p">,</span>
    <span class="c1"># 异常类</span>
    <span class="s2">&quot;RAGEngineError&quot;</span><span class="p">,</span>
    <span class="c1"># 抽象基类</span>
    <span class="s2">&quot;DocumentStore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VectorStore&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;EmbeddingService&quot;</span><span class="p">,</span>
    <span class="c1"># 服务类</span>
    <span class="s2">&quot;RetrievalService&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RerankingService&quot;</span><span class="p">,</span>
    <span class="c1"># 具体实现类</span>
    <span class="s2">&quot;MemoryDocumentStore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MemoryVectorStore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MockEmbeddingService&quot;</span><span class="p">,</span>
    <span class="c1"># 枚举</span>
    <span class="s2">&quot;RAGMode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RetrievalStrategy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RankingMethod&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GenerationMode&quot;</span><span class="p">,</span>
    <span class="c1"># 检索器</span>
    <span class="s2">&quot;Retriever&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SimilarityRetriever&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HybridRetriever&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KeywordRetriever&quot;</span><span class="p">,</span>
    <span class="c1"># 重排序器</span>
    <span class="s2">&quot;Reranker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CosineSimilarityReranker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BM25Reranker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HybridReranker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ReciprocalRankFusionReranker&quot;</span><span class="p">,</span>
    <span class="c1"># 生成器</span>
    <span class="s2">&quot;Generator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PromptBasedGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ChainOfThoughtGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HybridGenerator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FactCheckingGenerator&quot;</span><span class="p">,</span>
    <span class="c1"># 工厂和工具</span>
    <span class="s2">&quot;RAGEngineFactory&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RAGPerformanceOptimizer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RAGUtils&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2025, Zishu-Sensei Team。
      <span class="lastupdated">最后更新于 2025-10-17 21:09:36.
      </span></p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>