# é€‚é…å™¨å¸‚åœºå’Œç®¡ç†ç³»ç»Ÿ

> å®Œæˆæ—¥æœŸï¼š2025-10-19  
> çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

## æ¦‚è¿°

å·²å®Œæˆé€‚é…å™¨å¸‚åœºå’Œç®¡ç†ç³»ç»Ÿçš„å¼€å‘ï¼ŒåŒ…æ‹¬æœ¬åœ°é€‚é…å™¨ç®¡ç†ã€å¸‚åœºé›†æˆã€ç‰ˆæœ¬ç®¡ç†ã€ä¾èµ–ç®¡ç†å’Œæƒé™æ§åˆ¶ç­‰åŠŸèƒ½ã€‚

## å·²å®ç°åŠŸèƒ½

### 1. æœ¬åœ°æ•°æ®åº“æ¨¡å‹ âœ…

**æ–‡ä»¶**: `src-tauri/src/database/adapter.rs`

- âœ… é€‚é…å™¨åŸºç¡€ä¿¡æ¯è¡¨ (`installed_adapters`)
- âœ… ç‰ˆæœ¬å†å²è¡¨ (`adapter_versions`)
- âœ… ä¾èµ–å…³ç³»è¡¨ (`adapter_dependencies`)
- âœ… æƒé™é…ç½®è¡¨ (`adapter_permissions`)
- âœ… å®Œæ•´çš„ CRUD æ“ä½œ
- âœ… äº‹åŠ¡æ”¯æŒå’Œç´¢å¼•ä¼˜åŒ–

**æ•°æ®æ¨¡å‹**:
- `InstalledAdapter` - å·²å®‰è£…é€‚é…å™¨è®°å½•
- `AdapterVersion` - ç‰ˆæœ¬ä¿¡æ¯
- `AdapterDependency` - ä¾èµ–å…³ç³»
- `AdapterPermission` - æƒé™é…ç½®

### 2. å¸‚åœº API é›†æˆ âœ…

**æ–‡ä»¶**: `src-tauri/src/commands/market.rs`

**å‘½ä»¤åˆ—è¡¨**:
1. `search_market_products` - æœç´¢å¸‚åœºäº§å“
2. `get_market_product` - è·å–äº§å“è¯¦æƒ…
3. `get_featured_products` - è·å–æ¨èäº§å“
4. `get_product_reviews` - è·å–äº§å“è¯„è®º
5. `download_market_product` - ä¸‹è½½äº§å“
6. `check_product_updates` - æ£€æŸ¥äº§å“æ›´æ–°
7. `get_market_categories` - è·å–å¸‚åœºç±»åˆ«

**åŠŸèƒ½ç‰¹æ€§**:
- ğŸ” é«˜çº§æœç´¢å’Œè¿‡æ»¤
- â­ æ¨èäº§å“å±•ç¤º
- ğŸ’¬ è¯„è®ºå’Œè¯„åˆ†ï¼ˆåªè¯»ï¼‰
- ğŸ“¥ å®‰å…¨ä¸‹è½½å’Œæ ¡éªŒ
- ğŸ”„ è‡ªåŠ¨æ›´æ–°æ£€æŸ¥
- ğŸ“‚ åˆ†ç±»æµè§ˆ

### 3. é€‚é…å™¨ç®¡ç†å‘½ä»¤ âœ…

**æ–‡ä»¶**: `src-tauri/src/commands/adapter.rs`

**åŸºç¡€ç®¡ç†å‘½ä»¤**:
1. `get_installed_adapters` - è·å–å·²å®‰è£…é€‚é…å™¨åˆ—è¡¨
2. `get_enabled_adapters` - è·å–å·²å¯ç”¨é€‚é…å™¨åˆ—è¡¨
3. `get_installed_adapter` - è·å–å•ä¸ªé€‚é…å™¨è¯¦æƒ…
4. `toggle_adapter` - å¯ç”¨/ç¦ç”¨é€‚é…å™¨
5. `remove_installed_adapter` - åˆ é™¤é€‚é…å™¨

**ç‰ˆæœ¬ç®¡ç†å‘½ä»¤**:
6. `get_adapter_versions` - è·å–ç‰ˆæœ¬å†å²
7. `add_adapter_version` - æ·»åŠ ç‰ˆæœ¬è®°å½•

**ä¾èµ–ç®¡ç†å‘½ä»¤**:
8. `get_adapter_dependencies` - è·å–ä¾èµ–åˆ—è¡¨
9. `add_adapter_dependency` - æ·»åŠ ä¾èµ–
10. `remove_adapter_dependency` - åˆ é™¤ä¾èµ–

**æƒé™ç®¡ç†å‘½ä»¤**:
11. `get_adapter_permissions` - è·å–æƒé™åˆ—è¡¨
12. `grant_adapter_permission` - æˆäºˆ/æ’¤é”€æƒé™
13. `check_adapter_permission` - æ£€æŸ¥æƒé™
14. `add_adapter_permission` - æ·»åŠ æƒé™

### 4. å‰ç«¯æœåŠ¡å±‚ âœ…

**å¸‚åœºæœåŠ¡**: `src/services/marketService.ts`
- å®Œæ•´çš„å¸‚åœº API å°è£…
- TypeScript ç±»å‹å®šä¹‰
- å·¥å…·å‡½æ•°ï¼ˆæ ¼å¼åŒ–ã€å…¼å®¹æ€§æ£€æŸ¥ç­‰ï¼‰

**é€‚é…å™¨ç®¡ç†æœåŠ¡**: `src/services/adapterManagementService.ts`
- æœ¬åœ°é€‚é…å™¨ç®¡ç† API
- ç‰ˆæœ¬ã€ä¾èµ–ã€æƒé™ç®¡ç†
- çŠ¶æ€å’Œé£é™©è¯„ä¼°å·¥å…·

## æŠ€æœ¯æ¶æ„

### åç«¯ï¼ˆRust + Tauriï¼‰

```
desktop_app/src-tauri/src/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ adapter.rs          # é€‚é…å™¨æ•°æ®åº“æ¨¡å‹
â”‚   â””â”€â”€ mod.rs              # æ•°æ®åº“ç®¡ç†å™¨ï¼ˆå·²æ›´æ–°ï¼‰
â””â”€â”€ commands/
    â”œâ”€â”€ adapter.rs          # é€‚é…å™¨ç®¡ç†å‘½ä»¤ï¼ˆå¢å¼ºï¼‰
    â””â”€â”€ market.rs           # å¸‚åœºAPIå‘½ä»¤ï¼ˆæ–°å¢ï¼‰
```

**ç‰¹æ€§**:
- ğŸ”’ SQLite æ•°æ®åº“æŒä¹…åŒ–
- âš¡ å¼‚æ­¥å‘½ä»¤å¤„ç†
- ğŸ“Š è¯¦ç»†æ—¥å¿—è®°å½•
- ğŸ”„ äº‹åŠ¡æ”¯æŒ
- ğŸ›¡ï¸ é”™è¯¯å¤„ç†å’Œæ¢å¤

### å‰ç«¯ï¼ˆTypeScript + Reactï¼‰

```
desktop_app/src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ marketService.ts            # å¸‚åœºæœåŠ¡
â”‚   â”œâ”€â”€ adapterManagementService.ts # é€‚é…å™¨ç®¡ç†æœåŠ¡
â”‚   â””â”€â”€ adapter.ts                  # åŸæœ‰é€‚é…å™¨æœåŠ¡ï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ AdapterManagement.tsx       # é€‚é…å™¨ç®¡ç†é¡µé¢
â””â”€â”€ components/
    â””â”€â”€ ... (å¾…æ‰©å±•)
```

## èŒè´£åˆ’åˆ†

### æ¡Œé¢åº”ç”¨ï¼ˆå·²å®ç°ï¼‰

âœ… **æœ¬åœ°é€‚é…å™¨ç®¡ç†**
- é€‚é…å™¨å®‰è£…/å¸è½½
- ç‰ˆæœ¬ç®¡ç†
- ä¾èµ–å…³ç³»ç®¡ç†
- æƒé™æ§åˆ¶
- æœ¬åœ°æ•°æ®åº“å­˜å‚¨

âœ… **å¸‚åœºé›†æˆå®¢æˆ·ç«¯**
- æµè§ˆå’Œæœç´¢å¸‚åœº
- ä¸‹è½½é€‚é…å™¨
- æ£€æŸ¥æ›´æ–°
- æŸ¥çœ‹è¯„è®ºå’Œè¯„åˆ†

âœ… **åç«¯ API å¯¹æ¥**
- RESTful API å°è£…
- é”™è¯¯å¤„ç†
- æ•°æ®éªŒè¯

### ç¤¾åŒºå¹³å°ï¼ˆä¸åœ¨æ¡Œé¢åº”ç”¨èŒƒå›´ï¼‰

âŒ **ä¸åŒ…å«ä»¥ä¸‹åŠŸèƒ½** (ç”±å•ç‹¬çš„ç¤¾åŒºå¹³å°æä¾›):
- é€‚é…å™¨å•†åº— Web ç•Œé¢
- ç”¨æˆ·è´¦å·å’Œè®¤è¯
- é€‚é…å™¨ä¸Šä¼ å’Œå‘å¸ƒ
- è¯„åˆ†å’Œè¯„è®ºç³»ç»Ÿ
- ç¤¾äº¤åŠŸèƒ½
- å†…å®¹å®¡æ ¸

## ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```typescript
// æœç´¢é€‚é…å™¨
import MarketService from '@/services/marketService';

const results = await MarketService.searchProducts({
  query: 'code assistant',
  product_type: MarketProductType.Adapter,
  page: 1,
  page_size: 20,
});

// å®‰è£…é€‚é…å™¨
import AdapterManagementService from '@/services/adapterManagementService';

const adapters = await AdapterManagementService.getInstalledAdapters();

// ç®¡ç†æƒé™
await AdapterManagementService.grantPermission(
  'adapter-id',
  'file_read',
  true
);
```

### Rust å‘½ä»¤ç¤ºä¾‹

```rust
// åœ¨ Tauri åº”ç”¨ä¸­è°ƒç”¨
use crate::commands::market::*;
use crate::commands::adapter::*;

// è·å–å·²å®‰è£…é€‚é…å™¨
let adapters = get_installed_adapters(app_handle, state).await?;

// æ£€æŸ¥æ›´æ–°
let updates = check_product_updates(product_ids, app_handle, state).await?;
```

## æ•°æ®åº“æ¶æ„

### installed_adapters è¡¨
- å­˜å‚¨å·²å®‰è£…çš„é€‚é…å™¨åŸºæœ¬ä¿¡æ¯
- åŒ…å«ç‰ˆæœ¬ã€çŠ¶æ€ã€é…ç½®ç­‰å­—æ®µ
- æ”¯æŒå¯ç”¨/ç¦ç”¨åˆ‡æ¢

### adapter_versions è¡¨
- ç‰ˆæœ¬å†å²è®°å½•
- æ”¯æŒç‰ˆæœ¬å›æ»š
- å˜æ›´æ—¥å¿—è¿½è¸ª

### adapter_dependencies è¡¨
- ä¾èµ–å…³ç³»ç®¡ç†
- ç‰ˆæœ¬è¦æ±‚éªŒè¯
- å¿…éœ€/å¯é€‰ä¾èµ–åŒºåˆ†

### adapter_permissions è¡¨
- ç»†ç²’åº¦æƒé™æ§åˆ¶
- æƒé™æˆäºˆ/æ’¤é”€è®°å½•
- å®‰å…¨å®¡è®¡æ—¥å¿—

## å®‰å…¨ç‰¹æ€§

### æƒé™æ§åˆ¶
- âœ… ç»†ç²’åº¦æƒé™ç±»å‹ï¼ˆæ–‡ä»¶è¯»å†™ã€ç½‘ç»œã€ç³»ç»Ÿç­‰ï¼‰
- âœ… ç”¨æˆ·æˆæƒæµç¨‹
- âœ… æƒé™é£é™©è¯„çº§
- âœ… æƒé™ä½¿ç”¨å®¡è®¡

### æ²™ç›’éš”ç¦»
- â³ è¿›ç¨‹éš”ç¦»ï¼ˆå¾…å®ç°ï¼‰
- â³ æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ§åˆ¶ï¼ˆå¾…å®ç°ï¼‰
- â³ ç½‘ç»œè®¿é—®æ§åˆ¶ï¼ˆå¾…å®ç°ï¼‰

### æ•°æ®éªŒè¯
- âœ… è¾“å…¥éªŒè¯
- âœ… ç±»å‹æ£€æŸ¥
- âœ… é”™è¯¯å¤„ç†

## æ€§èƒ½ä¼˜åŒ–

- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- âœ… å¼‚æ­¥å‘½ä»¤å¤„ç†
- âœ… æ‰¹é‡æ“ä½œæ”¯æŒ
- âœ… ç¼“å­˜æœºåˆ¶ï¼ˆå¾…æ‰©å±•ï¼‰

## å¾…å®Œå–„åŠŸèƒ½

### é«˜ä¼˜å…ˆçº§
- [ ] å®Œå–„å®‰è£…å’Œæ›´æ–°æœåŠ¡
- [ ] æ²™ç›’éš”ç¦»å®ç°
- [ ] å‰ç«¯å®Œæ•´ UI ç»„ä»¶
- [ ] æ³¨å†Œæ‰€æœ‰å‘½ä»¤åˆ° main.rs

### ä¸­ä¼˜å…ˆçº§
- [ ] é€‚é…å™¨ç­¾åéªŒè¯
- [ ] å¢é‡æ›´æ–°æ”¯æŒ
- [ ] ä¸‹è½½è¿›åº¦é€šçŸ¥
- [ ] æ‰¹é‡å®‰è£…/æ›´æ–°

### ä½ä¼˜å…ˆçº§
- [ ] é€‚é…å™¨æ€§èƒ½ç›‘æ§
- [ ] ä½¿ç”¨ç»Ÿè®¡åˆ†æ
- [ ] è‡ªåŠ¨æ•…éšœæ¢å¤
- [ ] ç¤¾åŒºé›†æˆå¢å¼º

## API ç«¯ç‚¹ï¼ˆç¤¾åŒºå¹³å°éœ€å®ç°ï¼‰

å¸‚åœºå‘½ä»¤éœ€è¦ä»¥ä¸‹åç«¯ API ç«¯ç‚¹ï¼š

```
GET  /api/marketplace/search           # æœç´¢äº§å“
GET  /api/marketplace/products/:id     # è·å–äº§å“è¯¦æƒ…
GET  /api/marketplace/featured         # æ¨èäº§å“
GET  /api/marketplace/categories       # ç±»åˆ«åˆ—è¡¨
GET  /api/marketplace/products/:id/reviews  # äº§å“è¯„è®º
GET  /api/marketplace/products/:id/download # ä¸‹è½½é“¾æ¥
```

ç¯å¢ƒå˜é‡é…ç½®ï¼š
- `ZISHU_BACKEND_URL` - åç«¯ API åœ°å€ï¼ˆé»˜è®¤: http://localhost:8000ï¼‰

## æµ‹è¯•

```bash
# è¿è¡Œæ•°æ®åº“æµ‹è¯•
cd desktop_app/src-tauri
cargo test database::adapter::tests

# è¿è¡Œå‘½ä»¤æµ‹è¯•
cargo test commands::adapter
cargo test commands::market
```

## æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡](./DATABASE_SCHEMA.md)
- [API æ–‡æ¡£](./API_REFERENCE.md)
- [å¼€å‘æŒ‡å—](./DEVELOPMENT_GUIDE.md)

## è´¡çŒ®è€…

å¼€å‘å›¢é˜Ÿ

## æ›´æ–°æ—¥å¿—

### 2025-10-19
- âœ… å®Œæˆé€‚é…å™¨æ•°æ®åº“æ¨¡å‹
- âœ… å®Œæˆå¸‚åœº API é›†æˆ
- âœ… å®Œæˆé€‚é…å™¨ç®¡ç†å‘½ä»¤ï¼ˆ17ä¸ªå‘½ä»¤ï¼‰
- âœ… å®Œæˆå‰ç«¯æœåŠ¡å±‚
- âœ… æ·»åŠ ç‰ˆæœ¬ã€ä¾èµ–ã€æƒé™ç®¡ç†åŠŸèƒ½

## åç»­å·¥ä½œ

1. åœ¨ `main.rs` ä¸­æ³¨å†Œæ‰€æœ‰æ–°å‘½ä»¤
2. åˆ›å»ºå®Œæ•´çš„å‰ç«¯ UI ç»„ä»¶
3. å®ç°é€‚é…å™¨å®‰è£…å’Œæ›´æ–°æœåŠ¡
4. å®ç°æ²™ç›’éš”ç¦»
5. æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
6. ç¼–å†™ç”¨æˆ·æ–‡æ¡£

---

**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ  
**ä¸‹ä¸€æ­¥**: æ³¨å†Œå‘½ä»¤å¹¶åˆ›å»º UI ç»„ä»¶

