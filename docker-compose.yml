version: '3.8'

services:
  # API服务
  zishu-api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
      # 禁用 no_cache 以利用 Docker 缓存
      no_cache: false
    container_name: zishu-api
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-True}
      - LOG_LEVEL=${ZISHU_LOG_LEVEL:-INFO}
      - MODEL_PATH=${MODEL_PATH:-/app/models}
      - CACHE_DIR=${CACHE_DIR:-/app/cache}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # 开发模式：挂载源代码（代码变化无需重建镜像）
      - .:/app
      # 数据卷（只读/读写分离）
      - ./models:/app/models:ro
      - ./config:/app/config:ro
      - ./cache:/app/cache
      - ./logs:/app/logs
      # 挂载宿主机模型目录（用于访问大模型文件）
      - /data/disk/models:/data/disk/models:ro
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - zishu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # 向量数据库
  qdrant:
    image: qdrant/qdrant:v1.15.0
    container_name: zishu-qdrant
    ports:
      - "6335:6333"
      - "6336:6334"
    volumes:
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/qdrant:/qdrant/storage
      - ./config/services/qdrant.yml:/qdrant/config/production.yaml:ro
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    networks:
      - zishu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/6333 && echo -e 'GET /healthz HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && timeout 5 cat <&3 | grep -q 'healthz check passed'"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis缓存
  redis:
    image: redis:7.2-alpine
    container_name: zishu-redis
    ports:
      - "6379:6379"
    volumes:
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/redis:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-zishu123}
    networks:
      - zishu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: zishu-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=zishu
      - POSTGRES_USER=zishu
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-zishu123}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/postgres:/var/lib/postgresql/data
      - ./docker/postgres/01-init-db.sql:/docker-entrypoint-initdb.d/01-init-db.sql:ro
    networks:
      - zishu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zishu -d zishu"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Nginx反向代理
  nginx:
    image: nginx:1.25-alpine
    container_name: zishu-nginx
    ports:
      - "80:80"
      - "443:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
      - ./public/live2d_models:/usr/share/nginx/html/live2d_models:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - zishu-api
    networks:
      - zishu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

  # 监控服务 - Prometheus
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: zishu-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/prometheus:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - zishu-network
    restart: unless-stopped

  # 监控仪表板 - Grafana
  grafana:
    image: grafana/grafana:10.2.0
    container_name: zishu-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/grafana:/var/lib/grafana
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - zishu-network
    restart: unless-stopped

  # 日志收集 - Loki
  loki:
    image: grafana/loki:2.9.0
    container_name: zishu-loki
    ports:
      - "3100:3100"
    volumes:
      - ./docker/loki/loki.yml:/etc/loki/local-config.yaml:ro
      - ${CLOUD_DATA_PATH:-/data/disk/zishu-sensei}/data/loki:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - zishu-network
    restart: unless-stopped

  # 社区平台前端
  community-frontend:
    build:
      context: ./community_platform/frontend
      dockerfile: Dockerfile
    container_name: zishu-community-frontend
    ports:
      - "3001:3000"
    environment:
      - NEXT_PUBLIC_API_URL=/api
      - BACKEND_API_URL=http://localhost:8001/api/v1
      - NODE_ENV=development
    volumes:
      - ./community_platform/frontend:/app
      - /app/node_modules
    networks:
      - zishu-network
    restart: unless-stopped

  # 社区平台后端
  community-backend:
    build:
      context: ./community_platform/backend
      dockerfile: Dockerfile
    container_name: zishu-community-backend
    ports:
      - "8001:8000"
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=zishu
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-zishu123}
      - POSTGRES_DB=zishu_community
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-zishu123}
      - REDIS_DB=1
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - SECRET_KEY=${COMMUNITY_SECRET_KEY:-zishu-community-secret-key-change-in-production}
    volumes:
      - ./community_platform/backend:/app
      - ./community_platform/backend/uploads:/app/uploads
    depends_on:
      - postgres
      - redis
      - qdrant
    networks:
      - zishu-network
    restart: unless-stopped

networks:
  zishu-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  prometheus_data:
  grafana_data:
  loki_data:

# 环境变量说明：
# 创建 .env 文件并设置以下变量：
# CLOUD_DATA_PATH=/data/disk/zishu-sensei  # 云硬盘路径
# POSTGRES_PASSWORD=your_postgres_password
# REDIS_PASSWORD=your_redis_password  
# GRAFANA_PASSWORD=your_grafana_password
# QDRANT_API_KEY=your_qdrant_api_key
# OPENAI_API_KEY=your_openai_api_key
