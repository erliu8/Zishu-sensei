name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string

jobs:
  # éªŒè¯ç‰ˆæœ¬å·
  validate:
    name: éªŒè¯ç‰ˆæœ¬
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: get-version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬å·æ ¼å¼: $VERSION"
            echo "ç‰ˆæœ¬å·å¿…é¡»ç¬¦åˆ semantic versioning (ä¾‹å¦‚: v1.0.0)"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $VERSION"

      - name: æ£€æŸ¥ tag æ˜¯å¦å­˜åœ¨
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              echo "âŒ Tag $VERSION å·²å­˜åœ¨"
              exit 1
            fi
          fi

  # æ„å»º Changelog
  changelog:
    name: ç”Ÿæˆ Changelog
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      changelog: ${{ steps.generate.outputs.changelog }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç”Ÿæˆ Changelog
        id: generate
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags ${VERSION}^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # åˆ†ç±»æäº¤
          FEATURES=$(echo "$COMMITS" | grep -i "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -i "^- fix" || true)
          DOCS=$(echo "$COMMITS" | grep -i "^- docs" || true)
          CHORES=$(echo "$COMMITS" | grep -i "^- chore" || true)
          OTHERS=$(echo "$COMMITS" | grep -v -i "^- feat\|^- fix\|^- docs\|^- chore" || true)
          
          # ç”Ÿæˆ Changelog
          CHANGELOG="## ğŸ‰ Release ${VERSION}\n\n"
          
          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ æ–°åŠŸèƒ½\n${FEATURES}\n\n"
          fi
          
          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ› Bug ä¿®å¤\n${FIXES}\n\n"
          fi
          
          if [ -n "$DOCS" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ“ æ–‡æ¡£æ›´æ–°\n${DOCS}\n\n"
          fi
          
          if [ -n "$CHORES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ”§ å…¶ä»–æ›´æ”¹\n${CHORES}\n\n"
          fi
          
          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}### å…¶ä»–\n${OTHERS}\n\n"
          fi
          
          CHANGELOG="${CHANGELOG}### ğŸ“¦ å‘å¸ƒä¿¡æ¯\n"
          CHANGELOG="${CHANGELOG}- å‘å¸ƒæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
          CHANGELOG="${CHANGELOG}- æäº¤å“ˆå¸Œ: ${GITHUB_SHA:0:8}\n"
          
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG="${CHANGELOG}- å¯¹æ¯”: [\`${PREVIOUS_TAG}...${VERSION}\`](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${VERSION})\n"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # æ›´æ–°ç‰ˆæœ¬å·
  bump-version:
    name: æ›´æ–°ç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    needs: [validate, changelog]
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ›´æ–° package.json
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VERSION_NUMBER=${VERSION#v}
          
          # æ›´æ–° package.json
          npm version $VERSION_NUMBER --no-git-tag-version
          
          git add package.json package-lock.json
          git commit -m "chore: bump version to $VERSION"
          git push

      - name: åˆ›å»º Tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          git tag -a $VERSION -m "Release $VERSION"
          git push origin $VERSION

  # æ„å»ºå‘å¸ƒåŒ…
  build:
    name: æ„å»ºå‘å¸ƒåŒ…
    runs-on: ubuntu-latest
    needs: [validate, changelog]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œæµ‹è¯•
        run: |
          npm run test:coverage
          npm run type-check
          npm run lint

      - name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: npm run build
        env:
          NODE_ENV: production
          BUILD_VERSION: ${{ needs.validate.outputs.version }}

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          tar -czf zishu-frontend-${VERSION}.tar.gz .next public package.json package-lock.json next.config.ts

      - name: ä¸Šä¼ å‘å¸ƒåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: zishu-frontend-*.tar.gz
          retention-days: 90

  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, changelog, build]
    if: always() && needs.build.result == 'success'
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½å‘å¸ƒåŒ…
        uses: actions/download-artifact@v4
        with:
          name: release-package

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body: ${{ needs.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          files: |
            zishu-frontend-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    if: always()
    steps:
      - name: å‘é€ Slack é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: secrets.SLACK_WEBHOOK != ''
        with:
          status: ${{ needs.create-release.result }}
          text: |
            ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ: ${{ needs.validate.outputs.version }}
            çŠ¶æ€: ${{ needs.create-release.result }}
            æŸ¥çœ‹: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: secrets.MAIL_SERVER != ''
        run: |
          echo "å‘é€å‘å¸ƒé€šçŸ¥é‚®ä»¶..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶å‘é€é€»è¾‘

