name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨è¿è¡Œä¸€æ¬¡å®Œæ•´çš„ä»£ç è´¨é‡æ£€æŸ¥ (å‘¨æ—¥ UTC 6:00)
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»åž‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - lint
          - security
          - coverage
          - complexity

env:
  CARGO_TERM_COLOR: always

jobs:
  # ä»£ç é£Žæ ¼æ£€æŸ¥
  lint-check:
    name: ä»£ç é£Žæ ¼æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'lint' || github.event.inputs.check_type == 'all' || github.event_name != 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: å®‰è£…ä¾èµ–
        working-directory: desktop_app
        run: npm ci

      - name: ESLint æ£€æŸ¥
        working-directory: desktop_app
        run: |
          echo "## ðŸ” ESLint æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œ ESLint å¹¶ç”ŸæˆæŠ¥å‘Š
          npx eslint . --ext .ts,.tsx,.js,.jsx --format json --output-file eslint-report.json || true
          npx eslint . --ext .ts,.tsx,.js,.jsx --format unix > eslint-output.txt || true
          
          # ç»Ÿè®¡é”™è¯¯å’Œè­¦å‘Š
          ERRORS=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' eslint-report.json 2>/dev/null || echo "0")
          WARNINGS=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' eslint-report.json 2>/dev/null || echo "0")
          
          echo "| ç±»åž‹ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| é”™è¯¯ | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| è­¦å‘Š | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
          
          if [[ $ERRORS -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ ESLint é”™è¯¯" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -20 eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Prettier æ ¼å¼æ£€æŸ¥
        working-directory: desktop_app
        run: |
          echo "### ðŸ’… Prettier æ ¼å¼æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          if npx prettier --check . --ignore-path .gitignore; then
            echo "âœ… ä»£ç æ ¼å¼æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ä»£ç æ ¼å¼ä¸æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·è¿è¡Œ \`npm run format\` ä¿®å¤æ ¼å¼é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Rust æ ¼å¼æ£€æŸ¥
        working-directory: desktop_app/src-tauri
        run: |
          echo "### ðŸ¦€ Rust æ ¼å¼æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          if cargo fmt --check; then
            echo "âœ… Rust ä»£ç æ ¼å¼æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Rust ä»£ç æ ¼å¼ä¸æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·è¿è¡Œ \`cargo fmt\` ä¿®å¤æ ¼å¼é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Clippy æ£€æŸ¥
        working-directory: desktop_app/src-tauri
        run: |
          echo "### ðŸ“Ž Clippy æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œ Clippy å¹¶æ•èŽ·è¾“å‡º
          if cargo clippy --all-targets --all-features -- -D warnings > clippy-output.txt 2>&1; then
            echo "âœ… Clippy æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Clippy å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -20 clippy-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: TypeScript ç±»åž‹æ£€æŸ¥
        working-directory: desktop_app
        run: |
          echo "### ðŸ”· TypeScript ç±»åž‹æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          if npx tsc --noEmit; then
            echo "âœ… TypeScript ç±»åž‹æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ TypeScript ç±»åž‹é”™è¯¯" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'security' || github.event.inputs.check_type == 'all' || github.event_name != 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…ä¾èµ–
        working-directory: desktop_app
        run: npm ci

      - name: npm å®‰å…¨å®¡è®¡
        working-directory: desktop_app
        run: |
          echo "## ðŸ”’ å®‰å…¨æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### NPM å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œ npm audit
          if npm audit --audit-level moderate --format json > npm-audit.json 2>/dev/null; then
            echo "âœ… NPM å®¡è®¡é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            VULNERABILITIES=$(jq '.metadata.vulnerabilities' npm-audit.json 2>/dev/null || echo '{}')
            TOTAL=$(echo $VULNERABILITIES | jq '.info + .low + .moderate + .high + .critical' 2>/dev/null || echo "0")
            
            echo "| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $(echo $VULNERABILITIES | jq '.critical // 0') |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $(echo $VULNERABILITIES | jq '.high // 0') |" >> $GITHUB_STEP_SUMMARY
            echo "| Moderate | $(echo $VULNERABILITIES | jq '.moderate // 0') |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $(echo $VULNERABILITIES | jq '.low // 0') |" >> $GITHUB_STEP_SUMMARY
            echo "| Info | $(echo $VULNERABILITIES | jq '.info // 0') |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ€»è®¡** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            
            # å¦‚æžœæœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´žï¼Œå¤±è´¥
            CRITICAL=$(echo $VULNERABILITIES | jq '.critical // 0')
            HIGH=$(echo $VULNERABILITIES | jq '.high // 0')
            if [[ $CRITICAL -gt 0 ]] || [[ $HIGH -gt 0 ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **å‘çŽ°é«˜å±å®‰å…¨æ¼æ´žï¼Œè¯·ç«‹å³ä¿®å¤ï¼**" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

      - name: Cargo å®‰å…¨å®¡è®¡
        working-directory: desktop_app/src-tauri
        run: |
          echo "### Cargo å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          
          # å®‰è£… cargo-audit
          cargo install cargo-audit --quiet
          
          if cargo audit --format json > cargo-audit.json 2>/dev/null; then
            echo "âœ… Cargo å®¡è®¡é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Cargo å®¡è®¡å‘çŽ°é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            head -20 cargo-audit.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¾èµ–è®¸å¯è¯æ£€æŸ¥
        working-directory: desktop_app
        run: |
          echo "### ðŸ“„ è®¸å¯è¯æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          # å®‰è£… license-checker
          npm install -g license-checker
          
          # æ£€æŸ¥ NPM ä¾èµ–è®¸å¯è¯
          license-checker --json --out npm-licenses.json
          
          # ç»Ÿè®¡è®¸å¯è¯ç±»åž‹
          echo "#### NPM ä¾èµ–è®¸å¯è¯" >> $GITHUB_STEP_SUMMARY
          echo "| è®¸å¯è¯ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          
          jq -r 'to_entries[] | .value.licenses // "Unknown"' npm-licenses.json | \
            sort | uniq -c | sort -nr | head -10 | \
            while read count license; do
              echo "| $license | $count |" >> $GITHUB_STEP_SUMMARY
            done
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¦ç”¨çš„è®¸å¯è¯
          FORBIDDEN_LICENSES=("GPL-3.0" "AGPL-3.0" "LGPL-3.0")
          for license in "${FORBIDDEN_LICENSES[@]}"; do
            if jq -r 'to_entries[] | .value.licenses // "Unknown"' npm-licenses.json | grep -q "$license"; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âŒ **å‘çŽ°ç¦ç”¨è®¸å¯è¯: $license**" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

      - name: CodeQL åˆ†æž
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          queries: security-and-quality

      - name: æž„å»ºé¡¹ç›® (CodeQL)
        working-directory: desktop_app
        run: |
          npm run build

      - name: æ‰§è¡Œ CodeQL åˆ†æž
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # æµ‹è¯•è¦†ç›–çŽ‡
  coverage-check:
    name: æµ‹è¯•è¦†ç›–çŽ‡
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'coverage' || github.event.inputs.check_type == 'all' || github.event_name != 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£… Rust è¦†ç›–çŽ‡å·¥å…·
        run: cargo install cargo-tarpaulin

      - name: å®‰è£…ä¾èµ–
        working-directory: desktop_app
        run: npm ci

      - name: å‰ç«¯æµ‹è¯•è¦†ç›–çŽ‡
        working-directory: desktop_app
        run: |
          echo "## ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å‰ç«¯è¦†ç›–çŽ‡" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
          npm run test:coverage
          
          # è§£æžè¦†ç›–çŽ‡æ•°æ®
          if [[ -f "coverage/coverage-summary.json" ]]; then
            LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            
            echo "| æŒ‡æ ‡ | è¦†ç›–çŽ‡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| è¡Œè¦†ç›–çŽ‡ | ${LINES}% | $([ ${LINES%.*} -ge 80 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
            echo "| å‡½æ•°è¦†ç›–çŽ‡ | ${FUNCTIONS}% | $([ ${FUNCTIONS%.*} -ge 80 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
            echo "| åˆ†æ”¯è¦†ç›–çŽ‡ | ${BRANCHES}% | $([ ${BRANCHES%.*} -ge 70 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
            echo "| è¯­å¥è¦†ç›–çŽ‡ | ${STATEMENTS}% | $([ ${STATEMENTS%.*} -ge 80 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
            
            # æ£€æŸ¥è¦†ç›–çŽ‡é˜ˆå€¼
            if [[ ${LINES%.*} -lt 80 ]] || [[ ${FUNCTIONS%.*} -lt 80 ]] || [[ ${STATEMENTS%.*} -lt 80 ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **è¦†ç›–çŽ‡ä½ŽäºŽé˜ˆå€¼ï¼Œè¯·å¢žåŠ æµ‹è¯•ç”¨ä¾‹**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Rust æµ‹è¯•è¦†ç›–çŽ‡
        working-directory: desktop_app/src-tauri
        run: |
          echo "### Rust è¦†ç›–çŽ‡" >> $GITHUB_STEP_SUMMARY
          
          # è¿è¡Œ Rust æµ‹è¯•è¦†ç›–çŽ‡
          cargo tarpaulin --out Json --output-dir ../../coverage
          
          if [[ -f "../../coverage/tarpaulin-report.json" ]]; then
            COVERAGE=$(jq -r '.files | to_entries | map(.value.coverage) | add / length' ../../coverage/tarpaulin-report.json 2>/dev/null || echo "0")
            
            echo "| æŒ‡æ ‡ | è¦†ç›–çŽ‡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| Rust è¦†ç›–çŽ‡ | ${COVERAGE}% | $([ ${COVERAGE%.*} -ge 70 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ è¦†ç›–çŽ‡åˆ° Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: desktop_app/coverage
          flags: frontend
          name: frontend-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: è¦†ç›–çŽ‡è¶‹åŠ¿åˆ†æž
        if: github.event_name == 'pull_request'
        run: |
          echo "### ðŸ“ˆ è¦†ç›–çŽ‡è¶‹åŠ¿" >> $GITHUB_STEP_SUMMARY
          echo "è¦†ç›–çŽ‡æ•°æ®å·²ä¸Šä¼ åˆ° Codecovï¼Œå¯æŸ¥çœ‹è¯¦ç»†çš„è¦†ç›–çŽ‡æŠ¥å‘Šå’Œè¶‹åŠ¿åˆ†æžã€‚" >> $GITHUB_STEP_SUMMARY

  # ä»£ç å¤æ‚åº¦åˆ†æž
  complexity-analysis:
    name: ä»£ç å¤æ‚åº¦åˆ†æž
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'complexity' || github.event.inputs.check_type == 'all' || github.event_name != 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: desktop_app
        run: npm ci

      - name: å®‰è£…å¤æ‚åº¦åˆ†æžå·¥å…·
        run: |
          npm install -g complexity-report
          npm install -g jscpd

      - name: åœˆå¤æ‚åº¦åˆ†æž
        working-directory: desktop_app
        run: |
          echo "## ðŸ”„ ä»£ç å¤æ‚åº¦åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åœˆå¤æ‚åº¦" >> $GITHUB_STEP_SUMMARY
          
          # åˆ†æž TypeScript/JavaScript æ–‡ä»¶
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | \
            head -20 | \
            while read file; do
              if command -v cr &> /dev/null; then
                COMPLEXITY=$(cr "$file" --format json 2>/dev/null | jq -r '.reports[0].complexity.cyclomatic' 2>/dev/null || echo "N/A")
                echo "| $file | $COMPLEXITY |" >> $GITHUB_STEP_SUMMARY
              fi
            done || {
              echo "| æ–‡ä»¶ | å¤æ‚åº¦ |" >> $GITHUB_STEP_SUMMARY
              echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
              echo "| - | åˆ†æžå·¥å…·ä¸å¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
            }

      - name: ä»£ç é‡å¤æ£€æµ‹
        working-directory: desktop_app
        run: |
          echo "### ðŸ” ä»£ç é‡å¤æ£€æµ‹" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æµ‹ä»£ç é‡å¤
          if jscpd src --format json --output jscpd-report.json --silent; then
            if [[ -f "jscpd-report.json" ]]; then
              DUPLICATES=$(jq '.statistics.total.duplicatedLines // 0' jscpd-report.json)
              TOTAL_LINES=$(jq '.statistics.total.totalLines // 1' jscpd-report.json)
              DUPLICATE_PERCENT=$(echo "scale=2; $DUPLICATES * 100 / $TOTAL_LINES" | bc -l 2>/dev/null || echo "0")
              
              echo "| æŒ‡æ ‡ | å€¼ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
              echo "|------|-----|------|" >> $GITHUB_STEP_SUMMARY
              echo "| é‡å¤è¡Œæ•° | $DUPLICATES | - |" >> $GITHUB_STEP_SUMMARY
              echo "| æ€»è¡Œæ•° | $TOTAL_LINES | - |" >> $GITHUB_STEP_SUMMARY
              echo "| é‡å¤çŽ‡ | ${DUPLICATE_PERCENT}% | $([ ${DUPLICATE_PERCENT%.*} -le 10 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
              
              if [[ ${DUPLICATE_PERCENT%.*} -gt 15 ]]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âš ï¸ **ä»£ç é‡å¤çŽ‡è¿‡é«˜ï¼Œå»ºè®®é‡æž„**" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

      - name: æŠ€æœ¯å€ºåŠ¡åˆ†æž
        working-directory: desktop_app
        run: |
          echo "### ðŸ’³ æŠ€æœ¯å€ºåŠ¡" >> $GITHUB_STEP_SUMMARY
          
          # ç»Ÿè®¡ TODOã€FIXMEã€HACK ç­‰æ ‡è®°
          TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK\|XXX" src --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" | wc -l || echo "0")
          
          echo "| ç±»åž‹ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æŠ€æœ¯å€ºåŠ¡æ ‡è®° | $TODO_COUNT |" >> $GITHUB_STEP_SUMMARY
          
          if [[ $TODO_COUNT -gt 50 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **æŠ€æœ¯å€ºåŠ¡è¾ƒå¤šï¼Œå»ºè®®å®šæœŸæ¸…ç†**" >> $GITHUB_STEP_SUMMARY
          fi

  # è´¨é‡é—¨ç¦
  quality-gate:
    name: è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [lint-check, security-scan, coverage-check, complexity-analysis]
    if: always()
    steps:
      - name: è´¨é‡é—¨ç¦æ£€æŸ¥
        run: |
          echo "## ðŸšª è´¨é‡é—¨ç¦ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æ‰€æœ‰è´¨é‡æ£€æŸ¥ç»“æžœ
          LINT_STATUS="${{ needs.lint-check.result }}"
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          COVERAGE_STATUS="${{ needs.coverage-check.result }}"
          COMPLEXITY_STATUS="${{ needs.complexity-analysis.result }}"
          
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç é£Žæ ¼ | $([ "$LINT_STATUS" = "success" ] && echo 'âœ…' || [ "$LINT_STATUS" = "skipped" ] && echo 'â­ï¸' || echo 'âŒ') | $LINT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨æ‰«æ | $([ "$SECURITY_STATUS" = "success" ] && echo 'âœ…' || [ "$SECURITY_STATUS" = "skipped" ] && echo 'â­ï¸' || echo 'âŒ') | $SECURITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•è¦†ç›–çŽ‡ | $([ "$COVERAGE_STATUS" = "success" ] && echo 'âœ…' || [ "$COVERAGE_STATUS" = "skipped" ] && echo 'â­ï¸' || echo 'âŒ') | $COVERAGE_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| å¤æ‚åº¦åˆ†æž | $([ "$COMPLEXITY_STATUS" = "success" ] && echo 'âœ…' || [ "$COMPLEXITY_STATUS" = "skipped" ] && echo 'â­ï¸' || echo 'âŒ') | $COMPLEXITY_STATUS |" >> $GITHUB_STEP_SUMMARY
          
          # è®¡ç®—é€šè¿‡çš„æ£€æŸ¥é¡¹æ•°é‡
          PASSED=0
          TOTAL=0
          
          for status in "$LINT_STATUS" "$SECURITY_STATUS" "$COVERAGE_STATUS" "$COMPLEXITY_STATUS"; do
            if [[ "$status" != "skipped" ]]; then
              TOTAL=$((TOTAL + 1))
              if [[ "$status" = "success" ]]; then
                PASSED=$((PASSED + 1))
              fi
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è´¨é‡è¯„åˆ†**: $PASSED/$TOTAL" >> $GITHUB_STEP_SUMMARY
          
          # è´¨é‡é—¨ç¦åˆ¤æ–­
          if [[ $PASSED -eq $TOTAL ]] && [[ $TOTAL -gt 0 ]]; then
            echo "ðŸŽ‰ **è´¨é‡é—¨ç¦é€šè¿‡ï¼ä»£ç è´¨é‡è‰¯å¥½ã€‚**" >> $GITHUB_STEP_SUMMARY
          elif [[ $LINT_STATUS = "failure" ]] || [[ $SECURITY_STATUS = "failure" ]]; then
            echo "âŒ **è´¨é‡é—¨ç¦å¤±è´¥ï¼å­˜åœ¨ä¸¥é‡çš„ä»£ç è´¨é‡é—®é¢˜ã€‚**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âš ï¸ **è´¨é‡é—¨ç¦è­¦å‘Šï¼å»ºè®®ä¿®å¤å‘çŽ°çš„é—®é¢˜ã€‚**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: è´¨é‡æŠ¥å‘Šé€šçŸ¥
        if: github.event_name == 'pull_request'
        run: |
          # åœ¨ PR ä¸­æ·»åŠ è´¨é‡æŠ¥å‘Šè¯„è®º
          echo "ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼Œè¯¦ç»†ç»“æžœè¯·æŸ¥çœ‹ Actions é¡µé¢ã€‚" > quality-comment.md
