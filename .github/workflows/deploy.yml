name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬ (ç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  # éƒ¨ç½²åˆ°æ›´æ–°æœåŠ¡å™¨
  deploy-update-server:
    name: éƒ¨ç½²åˆ°æ›´æ–°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            RELEASE_ID="${{ github.event.release.id }}"
          else
            VERSION="${{ github.event.inputs.version }}"
            if [[ -z "$VERSION" ]]; then
              VERSION=$(gh release view --json tagName -q .tagName)
            fi
            RELEASE_ID=$(gh release view $VERSION --json id -q .id)
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "deployment_env=${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_OUTPUT
          
          echo "éƒ¨ç½²ç‰ˆæœ¬: $VERSION"
          echo "éƒ¨ç½²ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–å‘å¸ƒèµ„äº§ä¿¡æ¯
        id: assets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # è·å–å‘å¸ƒèµ„äº§åˆ—è¡¨
          ASSETS=$(gh release view $VERSION --json assets -q '.assets[] | {name: .name, url: .browserDownloadUrl, size: .size}')
          
          echo "assets<<EOF" >> $GITHUB_OUTPUT
          echo "$ASSETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯åˆ°æœåŠ¡å™¨
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ENV="${{ steps.version.outputs.deployment_env }}"
          
          # æ„å»ºæ›´æ–°ä¿¡æ¯
          UPDATE_INFO=$(cat << EOF
          {
            "version": "$VERSION",
            "environment": "$ENV",
            "released_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "release_notes": ${{ toJson(github.event.release.body || 'æ–°ç‰ˆæœ¬å‘å¸ƒ') }},
            "platforms": {
              "windows-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/$VERSION/zishu-sensei_${VERSION}_x64.msi",
                "signature": ""
              },
              "windows-arm64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/$VERSION/zishu-sensei_${VERSION}_arm64.msi",
                "signature": ""
              },
              "macos-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/$VERSION/zishu-sensei_${VERSION}_x64.dmg",
                "signature": ""
              },
              "macos-arm64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/$VERSION/zishu-sensei_${VERSION}_arm64.dmg",
                "signature": ""
              },
              "linux-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/$VERSION/zishu-sensei_${VERSION}_x64.deb",
                "signature": ""
              }
            }
          }
          EOF
          )
          
          # å‘é€åˆ°æ›´æ–°æœåŠ¡å™¨
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.UPDATE_SERVER_TOKEN }}" \
            -d "$UPDATE_INFO" \
            "${{ vars.UPDATE_SERVER_URL }}/api/releases" || {
              echo "æ›´æ–°æœåŠ¡å™¨é€šçŸ¥å¤±è´¥ï¼Œä½†ä¸å½±å“éƒ¨ç½²"
              exit 0
            }
          
          echo "âœ… æ›´æ–°æœåŠ¡å™¨å·²æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯"

  # éƒ¨ç½²åˆ° CDN
  deploy-cdn:
    name: éƒ¨ç½²åˆ° CDN
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.environment == 'production' || github.event_name == 'release'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
            if [[ -z "$VERSION" ]]; then
              VERSION=$(gh release view --json tagName -q .tagName)
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸‹è½½å‘å¸ƒèµ„äº§
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          mkdir -p downloads
          
          # ä¸‹è½½æ‰€æœ‰å‘å¸ƒèµ„äº§
          gh release download $VERSION --dir downloads --pattern "*.msi"
          gh release download $VERSION --dir downloads --pattern "*.exe"
          gh release download $VERSION --dir downloads --pattern "*.dmg"
          gh release download $VERSION --dir downloads --pattern "*.deb"
          gh release download $VERSION --dir downloads --pattern "*.rpm"
          gh release download $VERSION --dir downloads --pattern "*.AppImage"
          gh release download $VERSION --dir downloads --pattern "*.tar.gz"
          gh release download $VERSION --dir downloads --pattern "checksums.txt"
          
          echo "ä¸‹è½½çš„æ–‡ä»¶:"
          ls -la downloads/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® AWS CLI
        if: secrets.AWS_ACCESS_KEY_ID != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: ä¸Šä¼ åˆ° S3
        if: secrets.AWS_ACCESS_KEY_ID != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUCKET="${{ vars.S3_BUCKET }}"
          
          # ä¸Šä¼ æ–‡ä»¶åˆ° S3
          aws s3 sync downloads/ s3://$BUCKET/releases/$VERSION/ \
            --exclude "*" \
            --include "*.msi" \
            --include "*.exe" \
            --include "*.dmg" \
            --include "*.deb" \
            --include "*.rpm" \
            --include "*.AppImage" \
            --include "*.tar.gz" \
            --include "checksums.txt" \
            --cache-control "max-age=31536000"
          
          # æ›´æ–°æœ€æ–°ç‰ˆæœ¬ç´¢å¼•
          echo "$VERSION" | aws s3 cp - s3://$BUCKET/latest.txt \
            --cache-control "max-age=300"
          
          echo "âœ… æ–‡ä»¶å·²ä¸Šä¼ åˆ° CDN"

      - name: æ¸…é™¤ CloudFront ç¼“å­˜
        if: secrets.AWS_ACCESS_KEY_ID != '' && vars.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/releases/*" "/latest.txt"
          
          echo "âœ… CDN ç¼“å­˜å·²æ¸…é™¤"

  # éƒ¨ç½²æ–‡æ¡£
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: æ£€æŸ¥æ–‡æ¡£ç›®å½•
        run: |
          if [[ -d "docs" ]] && [[ -f "docs/package.json" ]]; then
            echo "found_docs=true" >> $GITHUB_ENV
          else
            echo "found_docs=false" >> $GITHUB_ENV
            echo "æœªæ‰¾åˆ°æ–‡æ¡£ç›®å½•ï¼Œè·³è¿‡æ–‡æ¡£éƒ¨ç½²"
          fi

      - name: æ„å»ºæ–‡æ¡£
        if: env.found_docs == 'true'
        run: |
          cd docs
          npm ci
          npm run build

      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: env.found_docs == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/dist
          cname: docs.zishu.dev

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify-deployment:
    name: é€šçŸ¥éƒ¨ç½²ç»“æœ
    runs-on: ubuntu-latest
    needs: [deploy-update-server, deploy-cdn, deploy-docs]
    if: always()
    steps:
      - name: æ±‡æ€»éƒ¨ç½²ç»“æœ
        run: |
          VERSION="${{ needs.deploy-update-server.outputs.version || github.event.release.tag_name }}"
          ENV="${{ github.event.inputs.environment || 'production' }}"
          
          echo "## ğŸš€ éƒ¨ç½²ç»“æœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**ç¯å¢ƒ**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "**æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²é¡¹ | çŠ¶æ€ | ç»“æœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æœåŠ¡å™¨ | ${{ needs.deploy-update-server.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.deploy-update-server.result == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CDN éƒ¨ç½² | ${{ needs.deploy-cdn.result == 'success' && 'âœ…' || needs.deploy-cdn.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-cdn.result == 'success' && 'æˆåŠŸ' || needs.deploy-cdn.result == 'skipped' && 'è·³è¿‡' || 'å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ–‡æ¡£éƒ¨ç½² | ${{ needs.deploy-docs.result == 'success' && 'âœ…' || needs.deploy-docs.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.deploy-docs.result == 'success' && 'æˆåŠŸ' || needs.deploy-docs.result == 'skipped' && 'è·³è¿‡' || 'å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY

      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.deploy-update-server.result == 'success'
        run: |
          VERSION="${{ needs.deploy-update-server.outputs.version || github.event.release.tag_name }}"
          ENV="${{ github.event.inputs.environment || 'production' }}"
          
          # Discord é€šçŸ¥
          if [[ -n "${{ secrets.DISCORD_WEBHOOK }}" ]]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "ğŸš€ éƒ¨ç½²æˆåŠŸ",
                  "description": "**Zishu Sensei '$VERSION'** å·²æˆåŠŸéƒ¨ç½²åˆ° **'$ENV'** ç¯å¢ƒ",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "ç‰ˆæœ¬",
                      "value": "'$VERSION'",
                      "inline": true
                    },
                    {
                      "name": "ç¯å¢ƒ", 
                      "value": "'$ENV'",
                      "inline": true
                    },
                    {
                      "name": "æ—¶é—´",
                      "value": "'$(date)'",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "Zishu Sensei CI/CD"
                  }
                }]
              }' \
              "${{ secrets.DISCORD_WEBHOOK }}" || echo "Discord é€šçŸ¥å‘é€å¤±è´¥"
          fi
          
          # Telegram é€šçŸ¥
          if [[ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]] && [[ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
                "text": "ğŸš€ *Zishu Sensei '$VERSION'* éƒ¨ç½²æˆåŠŸ\n\nğŸ“¦ ç‰ˆæœ¬: `'$VERSION'`\nğŸŒ ç¯å¢ƒ: `'$ENV'`\nâ° æ—¶é—´: `'$(date)'`",
                "parse_mode": "Markdown"
              }' \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" || echo "Telegram é€šçŸ¥å‘é€å¤±è´¥"
          fi

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: needs.deploy-update-server.result == 'failure' || needs.deploy-cdn.result == 'failure'
        run: |
          VERSION="${{ needs.deploy-update-server.outputs.version || github.event.release.tag_name }}"
          ENV="${{ github.event.inputs.environment || 'production' }}"
          
          # Discord é€šçŸ¥
          if [[ -n "${{ secrets.DISCORD_WEBHOOK }}" ]]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âŒ éƒ¨ç½²å¤±è´¥",
                  "description": "**Zishu Sensei '$VERSION'** éƒ¨ç½²åˆ° **'$ENV'** ç¯å¢ƒå¤±è´¥",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "ç‰ˆæœ¬",
                      "value": "'$VERSION'",
                      "inline": true
                    },
                    {
                      "name": "ç¯å¢ƒ",
                      "value": "'$ENV'",
                      "inline": true
                    },
                    {
                      "name": "å·¥ä½œæµ",
                      "value": "[æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
                  }
                }]
              }' \
              "${{ secrets.DISCORD_WEBHOOK }}" || echo "Discord é€šçŸ¥å‘é€å¤±è´¥"
          fi

  # åˆ›å»ºéƒ¨ç½²æ ‡ç­¾
  create-deployment-tag:
    name: åˆ›å»ºéƒ¨ç½²æ ‡ç­¾
    runs-on: ubuntu-latest
    needs: [deploy-update-server]
    if: needs.deploy-update-server.result == 'success'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»ºéƒ¨ç½²æ ‡ç­¾
        run: |
          VERSION="${{ needs.deploy-update-server.outputs.version || github.event.release.tag_name }}"
          ENV="${{ github.event.inputs.environment || 'production' }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          DEPLOY_TAG="deploy-${ENV}-${VERSION}-${TIMESTAMP}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git tag -a $DEPLOY_TAG -m "Deploy $VERSION to $ENV at $(date)"
          git push origin $DEPLOY_TAG
          
          echo "âœ… å·²åˆ›å»ºéƒ¨ç½²æ ‡ç­¾: $DEPLOY_TAG"