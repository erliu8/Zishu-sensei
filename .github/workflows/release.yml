name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      pre_release:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      draft:
        description: 'æ˜¯å¦ä¸ºè‰ç¨¿å‘å¸ƒ'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

defaults:
  run:
    working-directory: desktop_app

jobs:
  # ç‰ˆæœ¬æ£€æŸ¥å’Œå‡†å¤‡
  prepare-release:
    name: å‡†å¤‡å‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      is_draft: ${{ steps.version.outputs.is_draft }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç¡®å®šç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION="${{ github.ref_name }}"
            TAG_NAME="${{ github.ref_name }}"
            IS_PRERELEASE="false"
            IS_DRAFT="false"
          else
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.pre_release }}"
            IS_DRAFT="${{ github.event.inputs.draft }}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "is_draft=${IS_DRAFT}" >> $GITHUB_OUTPUT
          
          echo "å‘å¸ƒç‰ˆæœ¬: ${VERSION}"
          echo "æ ‡ç­¾åç§°: ${TAG_NAME}"
          echo "é¢„å‘å¸ƒ: ${IS_PRERELEASE}"
          echo "è‰ç¨¿: ${IS_DRAFT}"

      - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ: $VERSION"
            echo "æ­£ç¡®æ ¼å¼: v1.0.0 æˆ– v1.0.0-beta"
            exit 1
          fi

      - name: æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "é”™è¯¯: æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨"
            exit 1
          fi

  # å¤šå¹³å°æ„å»º
  build:
    name: æ„å»º ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: prepare-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            os: 'windows-latest'
            rust_target: 'x86_64-pc-windows-msvc'
            arch: 'x64'
            ext: '.exe'
          - platform: 'windows-arm64'
            os: 'windows-latest'
            rust_target: 'aarch64-pc-windows-msvc'
            arch: 'arm64'
            ext: '.exe'
          - platform: 'macos-latest'
            os: 'macos-latest'
            rust_target: 'x86_64-apple-darwin'
            arch: 'x64'
            ext: ''
          - platform: 'macos-arm64'
            os: 'macos-latest'
            rust_target: 'aarch64-apple-darwin'
            arch: 'arm64'
            ext: ''
          - platform: 'ubuntu-latest'
            os: 'ubuntu-latest'
            rust_target: 'x86_64-unknown-linux-gnu'
            arch: 'x64'
            ext: ''

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "desktop_app/src-tauri -> target"
          key: ${{ matrix.rust_target }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # æ›´æ–° package.json
          npm version $VERSION_NUMBER --no-git-tag-version
          
          # æ›´æ–° Cargo.toml
          cd src-tauri
          sed -i.bak "s/^version = \".*\"/version = \"$VERSION_NUMBER\"/" Cargo.toml
          rm -f Cargo.toml.bak
          
          # æ›´æ–° tauri.conf.json
          sed -i.bak "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" tauri.conf.json
          rm -f tauri.conf.json.bak

      - name: å¯¼å…¥ä»£ç ç­¾åè¯ä¹¦ (Windows)
        if: matrix.os == 'windows-latest' && secrets.WINDOWS_CERTIFICATE != ''
        run: |
          echo "${{ secrets.WINDOWS_CERTIFICATE }}" | base64 --decode > certificate.p12
          echo "WINDOWS_CERTIFICATE_PATH=$PWD/certificate.p12" >> $GITHUB_ENV
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}

      - name: å¯¼å…¥ä»£ç ç­¾åè¯ä¹¦ (macOS)
        if: matrix.os == 'macos-latest' && secrets.APPLE_CERTIFICATE != ''
        run: |
          echo "${{ secrets.APPLE_CERTIFICATE }}" | base64 --decode > certificate.p12
          security create-keychain -p "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
          security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}

      - name: æ„å»ºåº”ç”¨
        run: npm run tauri:build -- --target ${{ matrix.rust_target }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          WINDOWS_CERTIFICATE_PATH: ${{ env.WINDOWS_CERTIFICATE_PATH }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          
          cd src-tauri/target/${{ matrix.rust_target }}/release/bundle
          
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            # Windows å®‰è£…åŒ…
            if [[ -d "msi" ]]; then
              for file in msi/*.msi; do
                if [[ -f "$file" ]]; then
                  mv "$file" "msi/zishu-sensei_${VERSION}_${ARCH}.msi"
                fi
              done
            fi
            if [[ -d "nsis" ]]; then
              for file in nsis/*.exe; do
                if [[ -f "$file" ]]; then
                  mv "$file" "nsis/zishu-sensei_${VERSION}_${ARCH}-setup.exe"
                fi
              done
            fi
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            # macOS åº”ç”¨åŒ…
            if [[ -d "macos" ]]; then
              for file in macos/*.app; do
                if [[ -d "$file" ]]; then
                  tar -czf "macos/zishu-sensei_${VERSION}_${ARCH}.app.tar.gz" -C "macos" "$(basename "$file")"
                fi
              done
              for file in macos/*.dmg; do
                if [[ -f "$file" ]]; then
                  mv "$file" "macos/zishu-sensei_${VERSION}_${ARCH}.dmg"
                fi
              done
            fi
          else
            # Linux åŒ…
            if [[ -d "deb" ]]; then
              for file in deb/*.deb; do
                if [[ -f "$file" ]]; then
                  mv "$file" "deb/zishu-sensei_${VERSION}_${ARCH}.deb"
                fi
              done
            fi
            if [[ -d "rpm" ]]; then
              for file in rpm/*.rpm; do
                if [[ -f "$file" ]]; then
                  mv "$file" "rpm/zishu-sensei_${VERSION}_${ARCH}.rpm"
                fi
              done
            fi
            if [[ -d "appimage" ]]; then
              for file in appimage/*.AppImage; do
                if [[ -f "$file" ]]; then
                  mv "$file" "appimage/zishu-sensei_${VERSION}_${ARCH}.AppImage"
                fi
              done
            fi
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            desktop_app/src-tauri/target/${{ matrix.rust_target }}/release/bundle/**/*
          retention-days: 7

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [prepare-release, build]
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          if [[ -f "CHANGELOG.md" ]]; then
            # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
            CHANGELOG=$(awk "/^## \[?${VERSION#v}\]?/ {flag=1; next} /^## / {flag=0} flag" CHANGELOG.md || echo "")
          else
            # å¦‚æœæ²¡æœ‰ CHANGELOG.mdï¼Œä» git å†å²ç”Ÿæˆ
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [[ -n "$PREVIOUS_TAG" ]]; then
              CHANGELOG=$(git log --pretty=format:"- %s" ${PREVIOUS_TAG}..HEAD)
            else
              CHANGELOG="é¦–æ¬¡å‘å¸ƒ"
            fi
          fi
          
          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="æ­¤ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚"
          fi
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag_name }}
          release_name: Zishu Sensei ${{ needs.prepare-release.outputs.version }}
          body: |
            ## ğŸ‰ Zishu Sensei ${{ needs.prepare-release.outputs.version }}
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½
            
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š
            
            #### Windows
            - **MSI å®‰è£…åŒ…** (æ¨è): `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.msi`
            - **EXE å®‰è£…åŒ…**: `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64-setup.exe`
            - **ARM64 ç‰ˆæœ¬**: `zishu-sensei_${{ needs.prepare-release.outputs.version }}_arm64.msi`
            
            #### macOS
            - **DMG é•œåƒ** (æ¨è): `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.dmg`
            - **App å‹ç¼©åŒ…**: `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.app.tar.gz`
            - **Apple Silicon**: `zishu-sensei_${{ needs.prepare-release.outputs.version }}_arm64.dmg`
            
            #### Linux
            - **DEB åŒ…** (Ubuntu/Debian): `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.deb`
            - **RPM åŒ…** (RedHat/SUSE): `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.rpm`
            - **AppImage** (é€šç”¨): `zishu-sensei_${{ needs.prepare-release.outputs.version }}_x64.AppImage`
            
            ### ğŸ” å®‰å…¨éªŒè¯
            æ‰€æœ‰å‘å¸ƒçš„å®‰è£…åŒ…éƒ½ç»è¿‡æ•°å­—ç­¾åï¼Œè¯·éªŒè¯ç­¾ååå†å®‰è£…ã€‚
            
            ### ğŸ“– æ–‡æ¡£
            - [ç”¨æˆ·æ‰‹å†Œ](https://docs.zishu.dev)
            - [å®‰è£…æŒ‡å—](https://docs.zishu.dev/installation)
            - [æ›´æ–°è¯´æ˜](https://docs.zishu.dev/changelog)
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/zishu-team/zishu-sensei/issues) ä¸­åé¦ˆã€‚

          draft: ${{ needs.prepare-release.outputs.is_draft }}
          prerelease: ${{ needs.prepare-release.outputs.is_prerelease }}

  # ä¸Šä¼ å‘å¸ƒèµ„äº§
  upload-assets:
    name: ä¸Šä¼ å‘å¸ƒèµ„äº§
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    strategy:
      matrix:
        platform: [windows-latest, windows-arm64, macos-latest, macos-arm64, ubuntu-latest]
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: artifacts/

      - name: ä¸Šä¼ èµ„äº§æ–‡ä»¶
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          UPLOAD_URL="${{ needs.create-release.outputs.upload_url }}"
          
          find artifacts/ -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.tar.gz" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) | while read file; do
            filename=$(basename "$file")
            echo "ä¸Šä¼ æ–‡ä»¶: $filename"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "${UPLOAD_URL%\{*}?name=$filename"
          done

  # æ›´æ–°æ£€æŸ¥æœåŠ¡
  update-server:
    name: æ›´æ–°æ£€æŸ¥æœåŠ¡
    runs-on: ubuntu-latest
    needs: [prepare-release, upload-assets]
    if: success()
    steps:
      - name: é€šçŸ¥æ›´æ–°æœåŠ¡å™¨
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          
          # è°ƒç”¨æ›´æ–°æœåŠ¡å™¨ API
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.UPDATE_SERVER_TOKEN }}" \
            -d '{
              "version": "'$VERSION'",
              "release_notes": "æ–°ç‰ˆæœ¬ '$VERSION' å·²å‘å¸ƒ",
              "download_urls": {
                "windows-x64": "https://github.com/zishu-team/zishu-sensei/releases/download/'$VERSION'/zishu-sensei_'$VERSION'_x64.msi",
                "windows-arm64": "https://github.com/zishu-team/zishu-sensei/releases/download/'$VERSION'/zishu-sensei_'$VERSION'_arm64.msi",
                "macos-x64": "https://github.com/zishu-team/zishu-sensei/releases/download/'$VERSION'/zishu-sensei_'$VERSION'_x64.dmg",
                "macos-arm64": "https://github.com/zishu-team/zishu-sensei/releases/download/'$VERSION'/zishu-sensei_'$VERSION'_arm64.dmg",
                "linux-x64": "https://github.com/zishu-team/zishu-sensei/releases/download/'$VERSION'/zishu-sensei_'$VERSION'_x64.deb"
              }
            }' \
            "https://update.zishu.dev/api/releases" || echo "æ›´æ–°æœåŠ¡å™¨é€šçŸ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°"

  # éƒ¨ç½²åå¤„ç†
  post-release:
    name: å‘å¸ƒåå¤„ç†
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release, upload-assets, update-server]
    if: always()
    steps:
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬ ${{ needs.prepare-release.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "å‘å¸ƒåœ°å€: https://github.com/zishu-team/zishu-sensei/releases/tag/${{ needs.prepare-release.outputs.tag_name }}"

      - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ ç‰ˆæœ¬ ${{ needs.prepare-release.outputs.version }} å‘å¸ƒå¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶é‡è¯•ã€‚"

      - name: å‘é€é€šçŸ¥åˆ° Discord/Telegram (å¯é€‰)
        if: success() && secrets.DISCORD_WEBHOOK != ''
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          RELEASE_URL="https://github.com/zishu-team/zishu-sensei/releases/tag/${{ needs.prepare-release.outputs.tag_name }}"
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "content": "ğŸ‰ **Zishu Sensei '$VERSION'** å·²å‘å¸ƒï¼\n\nğŸ“¦ [ä¸‹è½½åœ°å€]('$RELEASE_URL')\nğŸš€ å¿«æ¥ä½“éªŒæ–°åŠŸèƒ½å§ï¼"
            }' \
            "${{ secrets.DISCORD_WEBHOOK }}" || echo "Discord é€šçŸ¥å‘é€å¤±è´¥"