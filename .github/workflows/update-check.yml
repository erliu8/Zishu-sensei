name: Update Check

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡ä¾èµ–æ›´æ–° (UTC 2:00 = åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»åž‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - npm
          - cargo
          - system

env:
  CARGO_TERM_COLOR: always

defaults:
  run:
    working-directory: desktop_app

jobs:
  # NPM ä¾èµ–æ£€æŸ¥
  check-npm-updates:
    name: æ£€æŸ¥ NPM ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'npm' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      updates: ${{ steps.check.outputs.updates }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: å®‰è£… npm-check-updates
        run: npm install -g npm-check-updates

      - name: æ£€æŸ¥ä¾èµ–æ›´æ–°
        id: check
        run: |
          echo "æ­£åœ¨æ£€æŸ¥ NPM ä¾èµ–æ›´æ–°..."
          
          # æ£€æŸ¥å¯æ›´æ–°çš„ä¾èµ–
          UPDATES=$(ncu --jsonUpgraded --target minor)
          MAJOR_UPDATES=$(ncu --jsonUpgraded --target major)
          
          echo "minor_updates=$UPDATES" >> $GITHUB_OUTPUT
          echo "major_updates=$MAJOR_UPDATES" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [[ "$UPDATES" != "{}" ]] || [[ "$MAJOR_UPDATES" != "{}" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ°ä¾èµ–æ›´æ–°"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
          fi

      - name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "## ðŸ“¦ NPM ä¾èµ–æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### æ¬¡ç‰ˆæœ¬æ›´æ–° (å…¼å®¹)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check.outputs.minor_updates }}' | jq . >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "### ä¸»ç‰ˆæœ¬æ›´æ–° (å¯èƒ½ä¸å…¼å®¹)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check.outputs.major_updates }}' | jq . >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Cargo ä¾èµ–æ£€æŸ¥
  check-cargo-updates:
    name: æ£€æŸ¥ Cargo ä¾èµ–æ›´æ–°
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'cargo' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "desktop_app/src-tauri -> target"

      - name: å®‰è£… cargo-outdated
        run: cargo install cargo-outdated

      - name: æ£€æŸ¥ä¾èµ–æ›´æ–°
        id: check
        run: |
          echo "æ­£åœ¨æ£€æŸ¥ Cargo ä¾èµ–æ›´æ–°..."
          cd src-tauri
          
          # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
          OUTDATED=$(cargo outdated --format json --root-deps-only || echo '[]')
          
          echo "outdated_deps=$OUTDATED" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [[ "$OUTDATED" != "[]" ]]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "å‘çŽ° Cargo ä¾èµ–æ›´æ–°"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "æ‰€æœ‰ Cargo ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
          fi

      - name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "## ðŸ¦€ Cargo ä¾èµ–æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check.outputs.outdated_deps }}' | jq . >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ç³»ç»Ÿå·¥å…·æ£€æŸ¥
  check-system-updates:
    name: æ£€æŸ¥ç³»ç»Ÿå·¥å…·æ›´æ–°
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'system' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: æ£€æŸ¥å·¥å…·ç‰ˆæœ¬
        run: |
          echo "## ðŸ› ï¸ ç³»ç»Ÿå·¥å…·ç‰ˆæœ¬æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å·¥å…· | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Node.js
          NODE_CURRENT=$(node --version)
          NODE_LATEST=$(curl -s https://nodejs.org/dist/index.json | jq -r '.[0].version')
          NODE_STATUS="âœ…"
          if [[ "$NODE_CURRENT" != "$NODE_LATEST" ]]; then
            NODE_STATUS="âš ï¸"
          fi
          echo "| Node.js | $NODE_CURRENT | $NODE_LATEST | $NODE_STATUS |" >> $GITHUB_STEP_SUMMARY
          
          # Rust
          RUST_CURRENT=$(rustc --version | cut -d' ' -f2)
          RUST_LATEST=$(curl -s https://forge.rust-lang.org/infra/channel-releases.html | grep -oP 'Rust \K[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "unknown")
          RUST_STATUS="âœ…"
          if [[ "$RUST_CURRENT" != "$RUST_LATEST" ]] && [[ "$RUST_LATEST" != "unknown" ]]; then
            RUST_STATUS="âš ï¸"
          fi
          echo "| Rust | $RUST_CURRENT | $RUST_LATEST | $RUST_STATUS |" >> $GITHUB_STEP_SUMMARY
          
          # Tauri CLI
          TAURI_CURRENT=$(npx @tauri-apps/cli --version | cut -d' ' -f2)
          TAURI_LATEST=$(npm view @tauri-apps/cli version)
          TAURI_STATUS="âœ…"
          if [[ "$TAURI_CURRENT" != "$TAURI_LATEST" ]]; then
            TAURI_STATUS="âš ï¸"
          fi
          echo "| Tauri CLI | $TAURI_CURRENT | $TAURI_LATEST | $TAURI_STATUS |" >> $GITHUB_STEP_SUMMARY

  # å®‰å…¨å®¡è®¡
  security-audit:
    name: å®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: NPM å®‰å…¨å®¡è®¡
        run: |
          echo "## ðŸ”’ å®‰å…¨å®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # NPM å®¡è®¡
          echo "### NPM å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          if npm audit --audit-level moderate --format json > npm-audit.json; then
            echo "âœ… NPM å®¡è®¡é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat npm-audit.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cargo å®‰å…¨å®¡è®¡
        run: |
          # å®‰è£… cargo-audit
          cargo install cargo-audit
          
          echo "### Cargo å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          cd src-tauri
          if cargo audit --format json > ../cargo-audit.json; then
            echo "âœ… Cargo å®¡è®¡é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat ../cargo-audit.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # åˆ›å»ºæ›´æ–° PR
  create-update-pr:
    name: åˆ›å»ºä¾èµ–æ›´æ–° PR
    runs-on: ubuntu-latest
    needs: [check-npm-updates, check-cargo-updates]
    if: needs.check-npm-updates.outputs.has_updates == 'true' || needs.check-cargo-updates.outputs.has_updates == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: åˆ›å»ºæ›´æ–°åˆ†æ”¯
        run: |
          BRANCH_NAME="deps/automated-updates-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json

      - name: æ›´æ–° NPM ä¾èµ–
        if: needs.check-npm-updates.outputs.has_updates == 'true'
        run: |
          npm install -g npm-check-updates
          
          # åªæ›´æ–°æ¬¡ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬ (å®‰å…¨)
          ncu --upgrade --target minor
          npm install
          
          git add package.json package-lock.json
          git commit -m "chore: update npm dependencies (minor/patch)" || true

      - name: æ›´æ–° Cargo ä¾èµ–
        if: needs.check-cargo-updates.outputs.has_updates == 'true'
        run: |
          cd src-tauri
          
          # æ›´æ–° Cargo.lock
          cargo update
          
          git add Cargo.lock
          git commit -m "chore: update cargo dependencies" || true

      - name: è¿è¡Œæµ‹è¯•
        run: |
          npm run test:run
          npm run test:rust

      - name: æŽ¨é€åˆ†æ”¯å¹¶åˆ›å»º PR
        run: |
          git push origin $BRANCH_NAME
          
          # åˆ›å»º PR
          gh pr create \
            --title "ðŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–° $(date +%Y-%m-%d)" \
            --body "## ðŸ“¦ è‡ªåŠ¨ä¾èµ–æ›´æ–°

          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ PRï¼Œç”¨äºŽæ›´æ–°é¡¹ç›®ä¾èµ–ã€‚

          ### ðŸ“‹ æ›´æ–°å†…å®¹
          - ðŸŸ¢ å®‰å…¨çš„æ¬¡ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬æ›´æ–°
          - ðŸ”’ å·²é€šè¿‡å®‰å…¨å®¡è®¡
          - âœ… æ‰€æœ‰æµ‹è¯•å·²é€šè¿‡

          ### ðŸ” å®¡æŸ¥è¦ç‚¹
          - [ ] æ£€æŸ¥æ›´æ–°æ—¥å¿—ä¸­çš„ç ´åæ€§å˜æ›´
          - [ ] éªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸
          - [ ] ç¡®è®¤æµ‹è¯•è¦†ç›–çŽ‡

          ### ðŸ¤– è‡ªåŠ¨åŒ–ä¿¡æ¯
          - åˆ›å»ºæ—¶é—´: $(date)
          - è§¦å‘æ–¹å¼: å®šæ—¶ä»»åŠ¡
          - å·¥ä½œæµ: ${{ github.workflow }}

          å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç»´æŠ¤å›¢é˜Ÿã€‚" \
            --label "dependencies,automated" \
            --assignee ${{ github.actor }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥ç»“æžœ
  notify-results:
    name: é€šçŸ¥æ£€æŸ¥ç»“æžœ
    runs-on: ubuntu-latest
    needs: [check-npm-updates, check-cargo-updates, security-audit, create-update-pr]
    if: always()
    steps:
      - name: æ±‡æ€»æ£€æŸ¥ç»“æžœ
        run: |
          echo "## ðŸ“Š ä¾èµ–æ£€æŸ¥æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM ä¾èµ– | ${{ needs.check-npm-updates.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.check-npm-updates.outputs.has_updates == 'true' && 'æœ‰æ›´æ–°' || 'æ— æ›´æ–°' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo ä¾èµ– | ${{ needs.check-cargo-updates.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.check-cargo-updates.outputs.has_updates == 'true' && 'æœ‰æ›´æ–°' || 'æ— æ›´æ–°' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨å®¡è®¡ | ${{ needs.security-audit.result == 'success' && 'âœ…' || needs.security-audit.result == 'skipped' && 'â­ï¸' || 'âŒ' }} | ${{ needs.security-audit.result == 'success' && 'é€šè¿‡' || needs.security-audit.result == 'skipped' && 'è·³è¿‡' || 'å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.create-update-pr.result }}" == "success" ]]; then
            echo "| æ›´æ–° PR | âœ… | å·²åˆ›å»º |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-update-pr.result }}" == "skipped" ]]; then
            echo "| æ›´æ–° PR | â­ï¸ | æ— éœ€åˆ›å»º |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| æ›´æ–° PR | âŒ | åˆ›å»ºå¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æŸ¥å®Œæˆæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
