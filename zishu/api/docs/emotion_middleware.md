# æƒ…ç»ªå¤„ç†ä¸­é—´ä»¶æ–‡æ¡£

## æ¦‚è¿°

æƒ…ç»ªå¤„ç†ä¸­é—´ä»¶æ˜¯Zishu-senseié¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œæä¾›æ™ºèƒ½æƒ…ç»ªåˆ†æã€æƒ…ç»ªè½¬æ¢ã€æƒ…ç»ªè®°å¿†å’Œæƒ…ç»ªå“åº”ç”ŸæˆåŠŸèƒ½ã€‚è¯¥ä¸­é—´ä»¶èƒ½å¤Ÿç†è§£ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„æƒ…ç»ªåŒ–å“åº”ï¼Œä½¿AIè§’è‰²æ›´åŠ ç”ŸåŠ¨å’Œäººæ€§åŒ–ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ­ æƒ…ç»ªåˆ†æ
- **å¤šç§åˆ†æå™¨æ”¯æŒ**ï¼šåŸºäºè§„åˆ™ã€æœºå™¨å­¦ä¹ æ¨¡å‹ã€å…³é”®è¯åŒ¹é…
- **æƒ…ç»ªç±»å‹è¯†åˆ«**ï¼šæ”¯æŒ10+ç§æƒ…ç»ªç±»å‹ï¼ˆå¼€å¿ƒã€æ‚²ä¼¤ã€æ„¤æ€’ã€å…´å¥‹ç­‰ï¼‰
- **å¼ºåº¦å’Œç½®ä¿¡åº¦è¯„ä¼°**ï¼šé‡åŒ–æƒ…ç»ªçš„å¼ºåº¦å’Œè¯†åˆ«çš„å¯ä¿¡åº¦
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè¯†åˆ«å¯¹è¯åœºæ™¯ï¼ˆé—®å€™ã€å‘Šåˆ«ã€æé—®ç­‰ï¼‰
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒä¸­æ–‡æ–‡æœ¬å’Œè¡¨æƒ…ç¬¦å·

### ğŸ”„ æƒ…ç»ªè½¬æ¢
- **çŠ¶æ€æœºç®¡ç†**ï¼šåŸºäºæƒ…ç»ªçŠ¶æ€æœºçš„è½¬æ¢é€»è¾‘
- **å¹³æ»‘è¿‡æ¸¡**ï¼šé¿å…æƒ…ç»ªçªå˜ï¼Œæä¾›è‡ªç„¶çš„æƒ…ç»ªå˜åŒ–
- **è§’è‰²ä¸ªæ€§é€‚é…**ï¼šæ ¹æ®è§’è‰²æ€§æ ¼è°ƒæ•´è½¬æ¢æ¦‚ç‡
- **ç¨³å®šæ€§æ§åˆ¶**ï¼šå¯é…ç½®çš„æƒ…ç»ªç¨³å®šæ€§å‚æ•°

### ğŸ§  æƒ…ç»ªè®°å¿†
- **çŸ­æœŸè®°å¿†**ï¼šæœ€è¿‘10æ¡æƒ…ç»ªçŠ¶æ€è®°å½•
- **é•¿æœŸè®°å¿†**ï¼šé‡è¦æƒ…ç»ªäº‹ä»¶çš„æŒä¹…åŒ–å­˜å‚¨
- **æ¨¡å¼è¯†åˆ«**ï¼šåˆ†æç”¨æˆ·çš„æƒ…ç»ªå€¾å‘å’Œä¹ æƒ¯
- **å†å²å½±å“**ï¼šåŸºäºå†å²æƒ…ç»ªè°ƒæ•´å½“å‰åˆ†æç»“æœ

### ğŸ’¬ å“åº”ç”Ÿæˆ
- **è¯­è°ƒè°ƒæ•´**ï¼šæ ¹æ®æƒ…ç»ªçŠ¶æ€ä¿®æ”¹å›å¤è¯­è°ƒ
- **è¡¨è¾¾å¼ºåŒ–**ï¼šæ·»åŠ æƒ…ç»ªåŒ–çš„å‰ç¼€ã€åç¼€å’Œæ ‡ç‚¹ç¬¦å·
- **å¤šæ¨¡æ€å»ºè®®**ï¼šæä¾›è¯­éŸ³é£æ ¼å’ŒåŠ¨ç”»è¡¨æƒ…å»ºè®®
- **è§’è‰²ä¸€è‡´æ€§**ï¼šä¿æŒä¸è§’è‰²è®¾å®šçš„ä¸€è‡´æ€§

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EmotionMiddleware                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ EmotionAnalyzer â”‚  â”‚TransitionEngine â”‚  â”‚ResponseGen   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ RuleBased     â”‚  â”‚ â€¢ StateRules    â”‚  â”‚ â€¢ ToneModify â”‚ â”‚
â”‚  â”‚ â€¢ MLBased       â”‚  â”‚ â€¢ Stability     â”‚  â”‚ â€¢ VoiceStyle â”‚ â”‚
â”‚  â”‚ â€¢ KeywordMatch  â”‚  â”‚ â€¢ Smoothing     â”‚  â”‚ â€¢ Animation  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                EmotionMemory                            â”‚ â”‚
â”‚  â”‚ â€¢ ShortTerm (deque)  â€¢ LongTerm (list)  â€¢ Patterns     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç±»å’Œæ¥å£

### EmotionState
æƒ…ç»ªçŠ¶æ€æ•°æ®ç±»ï¼ŒåŒ…å«ï¼š
- `emotion`: æƒ…ç»ªç±»å‹
- `intensity`: å¼ºåº¦ (0.0-1.0)
- `confidence`: ç½®ä¿¡åº¦ (0.0-1.0)
- `context`: ä¸Šä¸‹æ–‡åœºæ™¯
- `triggers`: è§¦å‘å› å­åˆ—è¡¨
- `timestamp`: æ—¶é—´æˆ³

### EmotionAnalyzer
æƒ…ç»ªåˆ†æå™¨æŠ½è±¡åŸºç±»ï¼š
- `analyze(text, context)`: åˆ†ææ–‡æœ¬æƒ…ç»ª
- `get_name()`: è·å–åˆ†æå™¨åç§°

### EmotionMiddleware
ä¸»è¦çš„ä¸­é—´ä»¶ç±»ï¼š
- `analyze_user_emotion()`: åˆ†æç”¨æˆ·æƒ…ç»ª
- `generate_response_emotion()`: ç”Ÿæˆå“åº”æƒ…ç»ª
- `enhance_response()`: å¢å¼ºå“åº”å†…å®¹

## ä½¿ç”¨æŒ‡å—

### åŸºç¡€ä½¿ç”¨

```python
from zishu.api.middleware.emotion import initialize_emotion_middleware

# åˆå§‹åŒ–ä¸­é—´ä»¶
middleware = initialize_emotion_middleware({
    'primary_analyzer': 'rule_based',
    'enable_memory': True,
    'enable_transition': True
})

# åˆ†æç”¨æˆ·æƒ…ç»ª
user_emotion = await middleware.analyze_user_emotion(
    text="æˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒï¼",
    user_id="user_123"
)

# ç”Ÿæˆè§’è‰²å“åº”
response_emotion = await middleware.generate_response_emotion(
    user_emotion=user_emotion,
    character_config=character_config,
    user_id="user_123"
)

# å¢å¼ºå“åº”
enhanced = await middleware.enhance_response(
    base_response="å¾ˆé«˜å…´å¬åˆ°è¿™ä¸ªæ¶ˆæ¯",
    emotion_state=response_emotion,
    character_config=character_config
)
```

### FastAPIé›†æˆ

```python
from fastapi import FastAPI, Depends
from zishu.api.middleware.emotion import (
    EmotionHTTPMiddleware,
    get_emotion_middleware
)

app = FastAPI()

# æ·»åŠ æƒ…ç»ªå¤„ç†ä¸­é—´ä»¶
app.add_middleware(EmotionHTTPMiddleware, emotion_middleware=middleware)

@app.post("/chat")
async def chat_endpoint(
    request: ChatRequest,
    middleware: EmotionMiddleware = Depends(get_emotion_middleware)
):
    # ä½¿ç”¨æƒ…ç»ªä¸­é—´ä»¶å¤„ç†èŠå¤©
    pass
```

### é…ç½®é€‰é¡¹

```json
{
  "emotion_middleware": {
    "primary_analyzer": "rule_based",
    "enable_transition": true,
    "enable_memory": true,
    "memory_ttl": 3600,
    "max_memory_entries": 1000,
    
    "analyzers": {
      "rule_based": {
        "enabled": true,
        "weight": 1.0
      },
      "ml_based": {
        "enabled": false,
        "model_path": ""
      }
    },
    
    "performance": {
      "max_processing_time": 1.0,
      "enable_caching": true,
      "enable_async": true
    }
  }
}
```

## æƒ…ç»ªç±»å‹

æ”¯æŒçš„æƒ…ç»ªç±»å‹åŒ…æ‹¬ï¼š

| æƒ…ç»ªç±»å‹ | æè¿° | ç¤ºä¾‹å…³é”®è¯ |
|---------|------|-----------|
| HAPPY | å¼€å¿ƒã€å¿«ä¹ | å¼€å¿ƒã€é«˜å…´ã€å¿«ä¹ã€ğŸ˜Š |
| SAD | æ‚²ä¼¤ã€éš¾è¿‡ | éš¾è¿‡ã€ä¼¤å¿ƒã€ğŸ˜¢ |
| ANGRY | æ„¤æ€’ã€ç”Ÿæ°” | ç”Ÿæ°”ã€æ„¤æ€’ã€ğŸ˜  |
| EXCITED | å…´å¥‹ã€æ¿€åŠ¨ | å…´å¥‹ã€æ¿€åŠ¨ã€å¤ªæ£’äº† |
| CONFUSED | å›°æƒ‘ã€è¿·æƒ‘ | å›°æƒ‘ã€ä¸æ‡‚ã€ğŸ¤” |
| CURIOUS | å¥½å¥‡ã€æ„Ÿå…´è¶£ | å¥½å¥‡ã€æœ‰è¶£ã€æƒ³çŸ¥é“ |
| CALM | å¹³é™ã€å†·é™ | å¹³é™ã€å†·é™ã€æ·¡å®š |
| TIRED | ç–²æƒ«ã€å›°å€¦ | ç´¯ã€ç–²æƒ«ã€ğŸ˜´ |
| ANXIOUS | ç„¦è™‘ã€æ‹…å¿ƒ | ç„¦è™‘ã€æ‹…å¿ƒã€ç´§å¼  |
| SURPRISED | æƒŠè®¶ã€æ„å¤– | æƒŠè®¶ã€æ„å¤–ã€ğŸ˜² |
| NEUTRAL | ä¸­æ€§ã€æ— æ˜æ˜¾æƒ…ç»ª | é»˜è®¤çŠ¶æ€ |

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- æƒ…ç»ªåˆ†æç»“æœç¼“å­˜
- ç”¨æˆ·æƒ…ç»ªæ¨¡å¼ç¼“å­˜
- å“åº”æ¨¡æ¿ç¼“å­˜

### å¹¶å‘å¤„ç†
- å¼‚æ­¥æƒ…ç»ªåˆ†æ
- æ‰¹é‡å¤„ç†æ”¯æŒ
- å¹¶å‘å®‰å…¨çš„å†…å­˜ç®¡ç†

### å†…å­˜ç®¡ç†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å¿†
- å¯é…ç½®çš„å†…å­˜é™åˆ¶
- å®šæœŸåƒåœ¾å›æ”¶

## æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰æƒ…ç»ªåˆ†æå™¨

```python
from zishu.api.middleware.emotion import EmotionAnalyzer, EmotionState

class CustomEmotionAnalyzer(EmotionAnalyzer):
    async def analyze(self, text: str, context=None) -> EmotionState:
        # å®ç°è‡ªå®šä¹‰åˆ†æé€»è¾‘
        pass
    
    def get_name(self) -> str:
        return "CustomAnalyzer"

# æ³¨å†Œè‡ªå®šä¹‰åˆ†æå™¨
middleware.analyzers['custom'] = CustomEmotionAnalyzer()
```

### è‡ªå®šä¹‰æƒ…ç»ªè½¬æ¢è§„åˆ™

```python
# æ·»åŠ è‡ªå®šä¹‰è½¬æ¢è§„åˆ™
middleware.transition_engine.transition_rules[EmotionType.CUSTOM] = {
    EmotionType.HAPPY: 0.3,
    EmotionType.CALM: 0.2
}
```

### è‡ªå®šä¹‰å“åº”ä¿®é¥°ç¬¦

```python
# æ·»åŠ è‡ªå®šä¹‰è¯­è°ƒä¿®é¥°ç¬¦
middleware.response_generator.tone_modifiers[EmotionType.CUSTOM] = {
    'prefixes': ['è‡ªå®šä¹‰å‰ç¼€'],
    'suffixes': ['è‡ªå®šä¹‰åç¼€'],
    'style_words': ['è‡ªå®šä¹‰è¯æ±‡']
}
```

## APIå‚è€ƒ

### ä¸»è¦æ–¹æ³•

#### analyze_user_emotion(text, user_id, context=None)
åˆ†æç”¨æˆ·è¾“å…¥æ–‡æœ¬çš„æƒ…ç»ªçŠ¶æ€ã€‚

**å‚æ•°ï¼š**
- `text` (str): è¦åˆ†æçš„æ–‡æœ¬
- `user_id` (str): ç”¨æˆ·ID
- `context` (dict, optional): é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯

**è¿”å›ï¼š** `EmotionState` å¯¹è±¡

#### generate_response_emotion(user_emotion, character_config, user_id, context=None)
åŸºäºç”¨æˆ·æƒ…ç»ªå’Œè§’è‰²é…ç½®ç”Ÿæˆå“åº”æƒ…ç»ªã€‚

**å‚æ•°ï¼š**
- `user_emotion` (EmotionState): ç”¨æˆ·æƒ…ç»ªçŠ¶æ€
- `character_config` (CharacterConfig): è§’è‰²é…ç½®
- `user_id` (str): ç”¨æˆ·ID
- `context` (dict, optional): é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯

**è¿”å›ï¼š** `EmotionState` å¯¹è±¡

#### enhance_response(base_response, emotion_state, character_config)
æ ¹æ®æƒ…ç»ªçŠ¶æ€å¢å¼ºåŸºç¡€å“åº”ã€‚

**å‚æ•°ï¼š**
- `base_response` (str): åŸºç¡€å“åº”æ–‡æœ¬
- `emotion_state` (EmotionState): æƒ…ç»ªçŠ¶æ€
- `character_config` (CharacterConfig): è§’è‰²é…ç½®

**è¿”å›ï¼š** åŒ…å«å¢å¼ºä¿¡æ¯çš„å­—å…¸

### å·¥å…·å‡½æ•°

#### initialize_emotion_middleware(config=None)
åˆå§‹åŒ–æƒ…ç»ªä¸­é—´ä»¶å®ä¾‹ã€‚

#### get_emotion_middleware()
è·å–å…¨å±€æƒ…ç»ªä¸­é—´ä»¶å•ä¾‹ã€‚

## ç›‘æ§å’Œè°ƒè¯•

### ç»Ÿè®¡ä¿¡æ¯
```python
stats = middleware.get_stats()
print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
print(f"æƒ…ç»ªæ£€æµ‹ç‡: {stats['emotion_detected'] / stats['total_requests']:.2%}")
print(f"å¹³å‡å¤„ç†æ—¶é—´: {stats['average_processing_time']:.4f}s")
```

### æ—¥å¿—è®°å½•
ä¸­é—´ä»¶æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
- æƒ…ç»ªåˆ†æç»“æœ
- è½¬æ¢å†³ç­–è¿‡ç¨‹
- æ€§èƒ½æŒ‡æ ‡
- é”™è¯¯ä¿¡æ¯

### è°ƒè¯•æ¨¡å¼
```python
# å¯ç”¨è°ƒè¯•æ¨¡å¼
middleware.config['debug_mode'] = True

# æŸ¥çœ‹è¯¦ç»†åˆ†æè¿‡ç¨‹
result = await middleware.analyze_user_emotion(text, user_id)
print(f"è§¦å‘å› å­: {result.triggers}")
print(f"ç½®ä¿¡åº¦: {result.confidence}")
```

## æœ€ä½³å®è·µ

### 1. åˆç†é…ç½®å†…å­˜ç®¡ç†
```python
config = {
    'memory_ttl': 3600,  # 1å°æ—¶è¿‡æœŸ
    'max_memory_entries': 10000,  # æœ€å¤§è®°å¿†æ¡ç›®
    'cleanup_interval': 300  # 5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
}
```

### 2. é€‰æ‹©åˆé€‚çš„åˆ†æå™¨
- å¿«é€Ÿå“åº”åœºæ™¯ï¼šä½¿ç”¨åŸºäºè§„åˆ™çš„åˆ†æå™¨
- é«˜ç²¾åº¦éœ€æ±‚ï¼šä½¿ç”¨æœºå™¨å­¦ä¹ åˆ†æå™¨
- èµ„æºå—é™ç¯å¢ƒï¼šä½¿ç”¨å…³é”®è¯åŒ¹é…

### 3. ä¼˜åŒ–è§’è‰²é…ç½®
```python
# ç¨³å®šå‹è§’è‰²
stable_character = CharacterConfig(
    emotion_stability=0.8,  # é«˜ç¨³å®šæ€§
    personality_type=PersonalityType.CALM
)

# æ´»æ³¼å‹è§’è‰²
lively_character = CharacterConfig(
    emotion_stability=0.3,  # ä½ç¨³å®šæ€§
    personality_type=PersonalityType.CHEERFUL
)
```

### 4. æ€§èƒ½ç›‘æ§
- å®šæœŸæ£€æŸ¥å¤„ç†æ—¶é—´
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- åˆ†ææƒ…ç»ªæ£€æµ‹å‡†ç¡®ç‡

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: æƒ…ç»ªåˆ†æç»“æœä¸å‡†ç¡®ï¼Ÿ**
A: æ£€æŸ¥åˆ†æå™¨é…ç½®ï¼Œè€ƒè™‘æ·»åŠ è‡ªå®šä¹‰å…³é”®è¯æˆ–è°ƒæ•´æƒé‡ã€‚

**Q: å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Ÿ**
A: è°ƒæ•´`memory_ttl`å’Œ`max_memory_entries`å‚æ•°ï¼Œå¯ç”¨è‡ªåŠ¨æ¸…ç†ã€‚

**Q: å“åº”é€Ÿåº¦æ…¢ï¼Ÿ**
A: å¯ç”¨ç¼“å­˜ï¼Œä½¿ç”¨æ›´å¿«çš„åˆ†æå™¨ï¼Œè€ƒè™‘å¼‚æ­¥å¤„ç†ã€‚

**Q: æƒ…ç»ªè½¬æ¢è¿‡äºé¢‘ç¹ï¼Ÿ**
A: å¢åŠ è§’è‰²çš„`emotion_stability`å‚æ•°ï¼Œè°ƒæ•´è½¬æ¢è§„åˆ™ã€‚

### é”™è¯¯å¤„ç†
ä¸­é—´ä»¶å†…ç½®äº†å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š
- åˆ†æå¤±è´¥æ—¶è¿”å›ä¸­æ€§æƒ…ç»ª
- ç½‘ç»œå¼‚å¸¸æ—¶ä½¿ç”¨ç¼“å­˜ç»“æœ
- å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ¸…ç†

