# 🏗️ Zishu-sensei 架构说明

## 📋 三层架构概览

Zishu-sensei 采用 **Web配置 → 云端打包 → 桌面运行** 的创新架构：

```
┌─────────────────────────────────────────────────────────────┐
│                   第一层：Web 社区平台                        │
│                    (https://zishu.dev)                       │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ 适配器市场  │  │ 可视化编排器  │  │  配置面板       │     │
│  │            │  │              │  │                 │     │
│  │ - 浏览适配器│  │ - 拖拽组合   │  │ - API密钥配置   │     │
│  │ - 搜索筛选 │  │ - 连接适配器 │  │ - 模型选择      │     │
│  │ - 评分评论 │  │ - 工作流预览 │  │ - 快捷键设置    │     │
│  └────────────┘  └──────────────┘  └─────────────────┘     │
│                          ↓                                  │
│              [ 点击"生成我的桌面宠物" ]                       │
│                          ↓                                  │
│              发送配置 JSON 到后端                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                   第二层：自动打包服务                        │
│                    (Backend API + Worker)                   │
│  ┌────────────────────────────────────────────────────┐    │
│  │  1. 接收用户配置 JSON                                │    │
│  │  2. 创建构建任务（Celery/Bull队列）                  │    │
│  │  3. Docker容器中构建：                               │    │
│  │     - 复制桌面应用模板                               │    │
│  │     - 注入用户配置                                   │    │
│  │     - 下载选中的适配器                               │    │
│  │     - 打包 Python 依赖                               │    │
│  │     - PyInstaller 生成 .exe                          │    │
│  │     - 制作 NSIS 安装程序                             │    │
│  │  4. 上传到 CDN                                       │    │
│  │  5. 返回下载链接                                     │    │
│  └────────────────────────────────────────────────────┘    │
│                                                             │
│  构建时间：5-10 分钟                                         │
│  输出产物：zishu-sensei-custom-xxx.exe (50-150MB)           │
└─────────────────────────────────────────────────────────────┘
                          ↓
                  用户下载 .exe 安装包
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                   第三层：Windows 桌面应用                    │
│              (用户本地安装运行的独立应用)                      │
│  ┌──────────────────────────────────────────────────┐      │
│  │         Tauri Shell (Rust + WebView2)            │      │
│  │  ┌────────────────────────────────────────┐     │      │
│  │  │       前端 UI (React + Live2D)          │     │      │
│  │  │  ┌──────────────┐  ┌─────────────────┐ │     │      │
│  │  │  │ Live2D 渲染  │  │  对话界面        │ │     │      │
│  │  │  │ - 角色动画   │  │  - 聊天气泡      │ │     │      │
│  │  │  │ - 表情变化   │  │  - 历史记录      │ │     │      │
│  │  │  │ - 鼠标交互   │  │  - 快捷指令      │ │     │      │
│  │  │  └──────────────┘  └─────────────────┘ │     │      │
│  │  └────────────────────────────────────────┘     │      │
│  │                      ↕                           │      │
│  │            Tauri Commands (IPC)                  │      │
│  │                      ↕                           │      │
│  │  ┌────────────────────────────────────────┐     │      │
│  │  │    Python 后端 (嵌入式运行)             │     │      │
│  │  │  ┌────────────┐  ┌──────────────────┐  │     │      │
│  │  │  │ AI Engine  │  │ 适配器执行引擎    │  │     │      │
│  │  │  │ - LLM调用  │  │ - 文件操作       │  │     │      │
│  │  │  │ - 上下文   │  │ - 网页自动化     │  │     │      │
│  │  │  │ - 记忆管理 │  │ - 办公软件控制   │  │     │      │
│  │  │  └────────────┘  └──────────────────┘  │     │      │
│  │  └────────────────────────────────────────┘     │      │
│  └──────────────────────────────────────────────────┘      │
│                                                             │
│  特性：                                                      │
│  - ✅ 透明窗口，桌面悬浮                                      │
│  - ✅ 系统托盘图标                                           │
│  - ✅ 全局快捷键                                             │
│  - ✅ 开机自启动（可选）                                      │
│  - ✅ 完全本地运行，无需联网（除了 LLM API 调用）             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔑 关键理解

### 1. Web 端 ≠ 桌面应用的 UI

**常见误解**：Web 端是桌面应用的网页版界面

**正确理解**：
- Web 端是一个**配置工具**，类似于 Chrome Web Store
- 用户在 Web 端选择功能、配置参数
- Web 端不运行任何 AI 能力或适配器
- Web 端的产出是一个**配置 JSON 文件**

### 2. 打包服务是核心创新

**传统方式**：用户下载通用的应用，自己安装插件

**Zishu-sensei 方式**：
- 用户在 Web 端定制自己的应用
- 后端自动打包成**独立的 .exe**
- 每个用户下载的都是**为自己定制的应用**
- 应用中已经包含了选中的适配器和配置

**类比**：
- 就像 Notion 的"导出为 PDF"
- 或者 WordPress 的"导出整站为静态文件"
- 但我们导出的是一个**可执行的桌面应用**

### 3. 桌面应用是完全独立的

**用户视角**：
1. 从 zishu.dev 下载了 `zishu-sensei-custom-xxx.exe`
2. 双击安装到 Windows
3. 启动后，看到可爱的 Live2D 宠物
4. 可以和宠物对话，使用各种 AI 功能
5. **不需要再访问 zishu.dev 网站**

**技术视角**：
- 桌面应用是一个 Tauri 应用（Rust + Web 技术）
- 内嵌了 Python 运行时和选中的适配器
- Live2D 渲染在本地进行
- 适配器也在本地执行
- 唯一的外部依赖是用户自己配置的 LLM API

---

## 📊 数据流

### 用户配置流程

```javascript
// 1. 用户在 Web 端的配置
const userConfig = {
  selectedAdapters: [
    'file-organizer',
    'web-automation', 
    'office-helper'
  ],
  llmConfig: {
    provider: 'openai',
    apiKey: 'sk-xxxxx',
    model: 'gpt-4'
  },
  character: {
    name: '小智',
    voice: 'female-1',
    personality: 'friendly'
  },
  shortcuts: {
    wakeup: 'Ctrl+Shift+Z',
    screenshot: 'Ctrl+Shift+S'
  }
}

// 2. 发送到打包服务
POST /api/packaging/create
{
  config: userConfig,
  platform: 'windows',
  template: 'standard'
}

// 3. 打包服务响应
{
  taskId: 'pkg-abc123',
  status: 'building',
  estimatedTime: 600  // 秒
}

// 4. 轮询构建状态
GET /api/packaging/pkg-abc123/status
{
  status: 'success',
  downloadUrl: 'https://cdn.zishu.dev/packages/pkg-abc123.exe',
  size: 128 * 1024 * 1024  // 128 MB
}

// 5. 用户下载并安装

// 6. 桌面应用启动时读取内嵌的配置
const config = loadEmbeddedConfig()
initializeAdapters(config.selectedAdapters)
connectToLLM(config.llmConfig)
renderLive2D(config.character)
```

---

## 🎯 为什么选择这种架构？

### 优势

1. **用户体验极佳**
   - 无需手动安装 Python、配置环境
   - 打开即用，开箱即用
   - 每个人都有定制的应用

2. **技术优雅**
   - Web 端专注于配置体验
   - 打包服务复用 CI/CD 经验
   - 桌面应用专注于性能和交互

3. **商业价值**
   - 可以追踪每个用户的定制配置
   - 适配器市场可以引入付费适配器
   - 打包服务可以作为增值服务

### 挑战

1. **打包服务复杂度**
   - 需要 Docker 容器化构建环境
   - 依赖管理和版本冲突
   - 构建时间优化（目标 < 10 分钟）

2. **桌面应用体积**
   - Python 运行时 + 依赖 ≈ 50-150MB
   - 需要优化打包策略
   - 可以考虑分层下载

3. **配置安全**
   - API 密钥如何安全存储
   - 可以考虑首次启动时再输入
   - 或者使用加密存储

---

## 🚀 开发优先级

### 阶段 1：核心验证（前 12 周）
1. **桌面应用模板** - 验证 Tauri + Python + Live2D 可行性
2. **基础适配器** - 3-5 个核心适配器能正常工作
3. **手动打包** - 手动打包一个应用，验证完整流程

### 阶段 2：自动化（12-20 周）
1. **打包服务 API** - 创建打包任务、查询状态、下载链接
2. **Docker 构建环境** - 容器化的构建流程
3. **Web 配置器** - 简单的表单式配置界面

### 阶段 3：生态完善（20-40 周）
1. **适配器市场** - 浏览、搜索、评分
2. **可视化编排器** - 拖拽式组合适配器
3. **社区功能** - 分享、评论、模板

---

## 💡 类似产品参考

### Electron Forge / Tauri Studio
- 但它们是开发者工具，需要写代码
- Zishu-sensei 是面向普通用户的可视化工具

### Zapier / n8n
- 它们是 Web 端的自动化工具
- Zishu-sensei 生成的是本地桌面应用

### Character.AI / ChatGPT Desktop
- 它们是通用的对话应用
- Zishu-sensei 强调定制化和本地能力扩展

---

## 🎯 技术亮点

1. **Web 配置 → 桌面应用** 的完整闭环
2. **每个用户都有定制的应用**，不是通用版本
3. **Live2D 桌面宠物** + **强大的本地自动化能力**
4. **开源社区驱动** 的适配器生态

这是一个技术创新性和商业价值兼具的项目！🚀

